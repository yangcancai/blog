<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Amazing Erlang">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Amazing Erlang">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Amazing Erlang">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>Amazing Erlang</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Amazing Erlang</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/17/applications-md/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Cameron">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Amazing Erlang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/17/applications-md/" itemprop="url">深度分析Erlang的application</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-17T14:05:12+08:00">
                2017-10-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Erlang基础知识/" itemprop="url" rel="index">
                    <span itemprop="name">Erlang基础知识</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>大家都知道Erlang是由基本的数据类型、函数、模块和supervisor树构成，引入application主要是为了不同的应用处理特定的功能，遵循模块化和组件的原则。一个复杂的Erlang项目都是由许多个不同功能的application组成的。今天我们来分析Erlang的application。</p>
<h3 id="启动一个application"><a href="#启动一个application" class="headerlink" title="启动一个application"></a>启动一个application</h3><p>根据Erlang的<a href="https://erlang.org/docs/" target="_blank" rel="external"><font color="blue">官方文档</font></a>我们创建一个ch_app，app下面由ch_sup_sup作为顶层的supervisor。<br>第二层是ch_sup,ch_sup的下面启动两个ch_worker<br><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="comment">%% src/ch_app.erl</span></div><div class="line"><span class="comment">%% 懒人一个模块处理所有的功能</span></div><div class="line"><span class="comment">%% 按照标准的opt规范还是要分开多个模块比较好</span></div><div class="line"><span class="keyword">-module</span><span class="params">(ch_app)</span>.</div><div class="line"><span class="keyword">-behaviour</span><span class="params">(application)</span>.</div><div class="line"><span class="keyword">-behaviour</span><span class="params">(supervisor)</span>.</div><div class="line"></div><div class="line"><span class="keyword">-export</span><span class="params">([start_link/<span class="number">2</span>])</span>.</div><div class="line"><span class="keyword">-export</span><span class="params">([init/<span class="number">1</span>])</span>.</div><div class="line"><span class="keyword">-export</span><span class="params">([new_process/<span class="number">0</span>])</span>.</div><div class="line"><span class="keyword">-export</span><span class="params">([start/<span class="number">2</span>, stop/<span class="number">1</span>])</span>.</div><div class="line"></div><div class="line"><span class="function"><span class="title">start</span><span class="params">(_Type, _Args)</span> -&gt;</span></div><div class="line">    ch_app:start_link(ch_sup_sup, master).</div><div class="line"></div><div class="line"><span class="function"><span class="title">stop</span><span class="params">(_State)</span> -&gt;</span></div><div class="line">    ok.</div><div class="line"><span class="function"><span class="title">start_link</span><span class="params">(Sup, Type)</span> -&gt;</span></div><div class="line">    &#123;ok, ChSup&#125; = supervisor:start_link(&#123;local, Sup&#125;, ?MODULE, [Type]),</div><div class="line">   [supervisor:start_child(ChSup, []) || _&lt;- [<span class="number">1</span>,<span class="number">2</span>]],</div><div class="line">   &#123;ok, ChSup&#125;.</div><div class="line"></div><div class="line"><span class="function"><span class="title">init</span><span class="params">([master])</span> -&gt;</span></div><div class="line">  SupFlags = #&#123;strategy =&gt; one_for_one, intensity =&gt; <span class="number">1</span>, period =&gt; <span class="number">10</span>&#125;,</div><div class="line">    ChildSpecs = [#&#123;id =&gt; ch3,</div><div class="line">                    start =&gt; &#123;ch_app, start_link, [ch_sup, child]&#125;,</div><div class="line">                    restart =&gt; permanent,</div><div class="line">                    shutdown =&gt; brutal_kill,</div><div class="line">                    type =&gt; supervisor,</div><div class="line">                    modules =&gt; [ch_app]&#125;],</div><div class="line">    &#123;ok, &#123;SupFlags, ChildSpecs&#125;&#125;;</div><div class="line">  init(_Args) -&gt;</div><div class="line">    SupFlags = #&#123;strategy =&gt; simple_one_for_one, intensity =&gt; <span class="number">0</span>, period =&gt; <span class="number">5</span>&#125;,</div><div class="line">    ChildSpecs = [#&#123;id =&gt; ch3,</div><div class="line">                    start =&gt; &#123;ch_app, new_process, []&#125;,</div><div class="line">                    restart =&gt; permanent,</div><div class="line">                    shutdown =&gt; brutal_kill,</div><div class="line">                    type =&gt; worker,</div><div class="line">                    modules =&gt; [ch_app]&#125;],</div><div class="line">    &#123;ok, &#123;SupFlags, ChildSpecs&#125;&#125;.</div><div class="line"></div><div class="line"><span class="function"><span class="title">new_process</span><span class="params">()</span> -&gt;</span></div><div class="line">  Pid = proc_lib:spawn_link(fun loop/0),</div><div class="line">  &#123;ok, Pid&#125;.</div><div class="line"></div><div class="line"><span class="function"><span class="title">loop</span><span class="params">()</span> -&gt;</span></div><div class="line">  <span class="keyword">receive</span></div><div class="line">    Msg -&gt;</div><div class="line">      io:format(<span class="string">" self=&gt; ~p, msg=&gt; ~p ~n"</span>,[self(), Msg]),</div><div class="line">     loop()</div><div class="line">  <span class="keyword">end</span>.</div><div class="line"></div><div class="line"><span class="comment">%% ebin/ch_app.app</span></div><div class="line"><span class="comment">%% application的callback模块在ch_app中</span></div><div class="line">&#123;application, ch_app,</div><div class="line"> [&#123;description, <span class="string">"Channel allocator"</span>&#125;,</div><div class="line">  &#123;vsn, <span class="string">"1"</span>&#125;,</div><div class="line">  &#123;modules, [ch_app]&#125;,</div><div class="line">  &#123;registered, []&#125;,</div><div class="line">  &#123;applications, [kernel, stdlib, sasl]&#125;,</div><div class="line">  &#123;mod, &#123;ch_app,[]&#125;&#125;</div><div class="line"> ]&#125;.</div></pre></td></tr></table></figure></p>
<p>编译<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">erlc -o ebin src/*.erl</div></pre></td></tr></table></figure></p>
<p>启动shell<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">erl -pa ebin</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">1&gt; application:start(ch_app).</div><div class="line">&#123;error,&#123;not_started,sasl&#125;&#125;</div><div class="line">2&gt; application:start(sasl).  </div><div class="line">ok</div><div class="line">3&gt; application:start(ch_app).</div><div class="line">OGRESS REPORT==== 17-Oct-2017::14:58:38 ===</div><div class="line">          supervisor: &#123;local,ch_sup_sup&#125;</div><div class="line">             started: [&#123;pid,&lt;0.76.0&gt;&#125;,</div><div class="line">                       &#123;id,ch3&#125;,</div><div class="line">                       &#123;mfargs,&#123;ch_app,start_link,[ch_sup,child]&#125;&#125;,</div><div class="line">                       &#123;restart_type,permanent&#125;,</div><div class="line">                       &#123;shutdown,brutal_kill&#125;,</div><div class="line">                       &#123;child_type,supervisor&#125;]</div><div class="line"></div><div class="line">=PROGRESS REPORT==== 17-Oct-2017::14:58:38 ===</div><div class="line">         application: ch_app</div><div class="line">          started_at: nonode@nohost</div><div class="line">ok</div></pre></td></tr></table></figure>
<p>打开observer我们来看看整个监控树<br><img src="/images/ch_app.png" alt="ch_app_tree"><br>ch_sup_sup往右面部分我们都知道是一个supervisor监控树，这一部分的supervisor分析可以看我的(<a href="/2017/10/16/let-supervisor-crash-md/" title="<font color=blue>动手搞死supervisor</font>"><font color="blue">动手搞死supervisor</font></a>)。这里ch_sup_sup左边的两个进程有什么作用呢？我们使用erlang:process_info()查看一下。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">5&gt; erlang:process_info(pid(0,73,0)).</div><div class="line">[&#123;current_function,&#123;application_master,main_loop,2&#125;&#125;,</div><div class="line"> &#123;initial_call,&#123;proc_lib,init_p,5&#125;&#125;,</div><div class="line"> &#123;status,waiting&#125;,</div><div class="line"> &#123;message_queue_len,0&#125;,</div><div class="line"> &#123;messages,[]&#125;,</div><div class="line"> &#123;links,[&lt;0.33.0&gt;,&lt;0.74.0&gt;]&#125;,%% 0.33.0是application_controller</div><div class="line"> &#123;dictionary,[&#123;&apos;$initial_call&apos;,&#123;application_master,init,4&#125;&#125;,</div><div class="line">              &#123;&apos;$ancestors&apos;,[&lt;0.72.0&gt;]&#125;]&#125;,</div><div class="line"> &#123;trap_exit,true&#125;,</div><div class="line"> &#123;error_handler,error_handler&#125;,</div><div class="line"> &#123;priority,normal&#125;,</div><div class="line"> &#123;group_leader,&lt;0.73.0&gt;&#125;,</div><div class="line"> &#123;total_heap_size,233&#125;,</div><div class="line"> &#123;heap_size,233&#125;,</div><div class="line"> &#123;stack_size,7&#125;,</div><div class="line"> &#123;reductions,27&#125;,</div><div class="line"> &#123;garbage_collection,[&#123;max_heap_size,#&#123;error_logger =&gt; true,kill =&gt; true,size =&gt; 0&#125;&#125;,</div><div class="line">                      &#123;min_bin_vheap_size,46422&#125;,</div><div class="line">                      &#123;min_heap_size,233&#125;,</div><div class="line">                      &#123;fullsweep_after,65535&#125;,</div><div class="line">                      &#123;minor_gcs,0&#125;]&#125;,</div><div class="line"> &#123;suspending,[]&#125;]</div><div class="line">6&gt;  whereis(application_controller).</div><div class="line">&lt;0.33.0&gt;</div><div class="line">7&gt; erlang:process_info(pid(0,74,0)).</div><div class="line">[&#123;current_function,&#123;application_master,loop_it,4&#125;&#125;,</div><div class="line"> &#123;initial_call,&#123;application_master,start_it,4&#125;&#125;,</div><div class="line"> &#123;status,waiting&#125;,</div><div class="line"> &#123;message_queue_len,0&#125;,</div><div class="line"> &#123;messages,[]&#125;,</div><div class="line"> &#123;links,[&lt;0.73.0&gt;,&lt;0.75.0&gt;]&#125;,%% 0.75.0是ch_sup_sup</div><div class="line"> &#123;dictionary,[]&#125;,</div><div class="line"> &#123;trap_exit,true&#125;,</div><div class="line"> &#123;error_handler,error_handler&#125;,</div><div class="line"> &#123;priority,normal&#125;,</div><div class="line"> &#123;group_leader,&lt;0.73.0&gt;&#125;,</div><div class="line"> &#123;total_heap_size,233&#125;,</div><div class="line"> &#123;heap_size,233&#125;,</div><div class="line"> &#123;stack_size,5&#125;,</div><div class="line"> &#123;reductions,83&#125;,</div><div class="line"> &#123;garbage_collection,[&#123;max_heap_size,#&#123;error_logger =&gt; true,kill =&gt; true,size =&gt; 0&#125;&#125;,</div><div class="line">                      &#123;min_bin_vheap_size,46422&#125;,</div><div class="line">                      &#123;min_heap_size,233&#125;,</div><div class="line">                      &#123;fullsweep_after,65535&#125;,</div><div class="line">                      &#123;minor_gcs,0&#125;]&#125;,</div><div class="line"> &#123;suspending,[]&#125;]</div><div class="line">8&gt;</div></pre></td></tr></table></figure></p>
<p>从current_function里面都看到了application_master这个模块，所以这两个进程的作用我们可以打开该模块的源码分析。0.73.0进程还link了0.33.0这个进程，0.33.0应该是application_controller进程，其主要作用可以从其名字就可以看出来了。为了分析这三个进程的关系我们直接从application:start(ch_app)函数入口。<br><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">%% application.erl</span></div><div class="line"><span class="function"><span class="title">start</span><span class="params">(Application, RestartType)</span> -&gt;</span></div><div class="line">    <span class="keyword">case</span> load(Application) <span class="keyword">of</span></div><div class="line">	ok -&gt;</div><div class="line">	    Name = get_appl_name(Application),</div><div class="line">	    application_controller:start_application(Name, RestartType);</div><div class="line">	&#123;error, &#123;already_loaded, Name&#125;&#125; -&gt;</div><div class="line">	    application_controller:start_application(Name, RestartType);</div><div class="line">	Error -&gt;</div><div class="line">	    Error</div><div class="line">    <span class="keyword">end</span>.</div><div class="line"><span class="function"><span class="title">stop</span><span class="params">(Application)</span> -&gt;</span></div><div class="line">    application_controller:stop_application(Application).</div></pre></td></tr></table></figure></p>
<p>从application.erl可以看出application模块是对application_controller模块的封装，主要的逻辑还是要到application_controller实现。<br><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line"><span class="comment">%% application_controller.erl</span></div><div class="line"><span class="function"><span class="title">handle_call</span><span class="params">(&#123;start_application, AppName, RestartType&#125;, From, S)</span> -&gt;</span></div><div class="line">    #state&#123;running = Running, starting = Starting, start_p_false = SPF, </div><div class="line">	   started = Started, start_req = Start_req&#125; = S,</div><div class="line">    <span class="comment">%% Check if the commandline environment variables are OK.</span></div><div class="line">    <span class="comment">%% Incase of erroneous variables do not start the application,</span></div><div class="line">    <span class="comment">%% if the application is permanent crash the node.</span></div><div class="line">    <span class="comment">%% Check if the application is already starting.</span></div><div class="line">    <span class="keyword">case</span> lists:keyfind(AppName, <span class="number">1</span>, Start_req) <span class="keyword">of</span></div><div class="line">	<span class="literal">false</span> -&gt;</div><div class="line">	    <span class="keyword">case</span> <span class="keyword">catch</span> check_start_cond(AppName, RestartType, Started, Running) <span class="keyword">of</span></div><div class="line">		&#123;ok, Appl&#125; -&gt;</div><div class="line">		    Cntrl = cntrl(AppName, S, &#123;ac_start_application_req, AppName&#125;),</div><div class="line">		    Perm = application:get_env(kernel, permissions),</div><div class="line">		    <span class="keyword">case</span> &#123;Cntrl, Perm&#125; <span class="keyword">of</span></div><div class="line">			&#123;true, _&#125; -&gt;</div><div class="line">			    &#123;noreply, S#state&#123;starting = [&#123;AppName, RestartType, normal, From&#125; |</div><div class="line">							  Starting],</div><div class="line">					      start_req = [&#123;AppName, From&#125; | Start_req]&#125;&#125;;</div><div class="line">			&#123;false, undefined&#125; -&gt;</div><div class="line">			    spawn_starter(From, Appl, S, normal),</div><div class="line">			    &#123;noreply, S#state&#123;starting = [&#123;AppName, RestartType, normal, From&#125; |</div><div class="line">							  Starting],</div><div class="line">					      start_req = [&#123;AppName, From&#125; | Start_req]&#125;&#125;;</div><div class="line">			&#123;false, &#123;ok, Perms&#125;&#125; -&gt;</div><div class="line">			    <span class="keyword">case</span> lists:member(&#123;AppName, false&#125;, Perms) <span class="keyword">of</span></div><div class="line">				<span class="literal">false</span> -&gt;</div><div class="line">				    spawn_starter(From, Appl, S, normal),</div><div class="line">				    &#123;noreply, S#state&#123;starting = [&#123;AppName, RestartType, normal, From&#125; |</div><div class="line">								  Starting],</div><div class="line">						      start_req = [&#123;AppName, From&#125; | Start_req]&#125;&#125;;</div><div class="line">				<span class="literal">true</span> -&gt;</div><div class="line">				    SS = S#state&#123;start_p_false = [&#123;AppName, RestartType, normal, From&#125; |</div><div class="line">								  SPF]&#125;,</div><div class="line">				    &#123;reply, ok, SS&#125;</div><div class="line">			    <span class="keyword">end</span></div><div class="line">		    <span class="keyword">end</span>;</div><div class="line">		&#123;error, _R&#125; = Error -&gt;</div><div class="line">		    &#123;reply, Error, S&#125;</div><div class="line">	    <span class="keyword">end</span>;</div><div class="line">	&#123;AppName, _FromX&#125; -&gt;</div><div class="line">	    SS = S#state&#123;start_req = [&#123;AppName, From&#125; | Start_req]&#125;,</div><div class="line">	    &#123;noreply, SS&#125;</div><div class="line">    <span class="keyword">end</span>;</div><div class="line"></div><div class="line"><span class="comment">%% 启动一个进程来启动app</span></div><div class="line"><span class="function"><span class="title">spawn_starter</span><span class="params">(From, Appl, S, Type)</span> -&gt;</span></div><div class="line">    spawn_link(?MODULE, init_starter, [From, Appl, S, Type]).</div><div class="line"></div><div class="line"><span class="function"><span class="title">init_starter</span><span class="params">(_From, Appl, S, Type)</span> -&gt;</span></div><div class="line">    process_flag(trap_exit, true),</div><div class="line">    AppName = Appl#appl.name,</div><div class="line"><span class="comment">%% 启动application的master进程然后把applicaton的信息存在在state里面</span></div><div class="line">    gen_server:cast(?AC, &#123;application_started, AppName, </div><div class="line">			  catch start_appl(Appl, S, Type)&#125;).</div><div class="line"></div><div class="line"><span class="function"><span class="title">start_appl</span><span class="params">(Appl, S, Type)</span> -&gt;</span></div><div class="line">    ApplData = Appl#appl.appl_data,</div><div class="line">    <span class="keyword">case</span> ApplData#appl_data.mod <span class="keyword">of</span></div><div class="line">	[] -&gt;</div><div class="line">	    &#123;ok, undefined&#125;;</div><div class="line">	_ -&gt;</div><div class="line">	    <span class="comment">%% Name = ApplData#appl_data.name,</span></div><div class="line">	    Running = S#state.running,</div><div class="line">	    foreach(</div><div class="line">	      <span class="keyword">fun</span>(AppName) -&gt;</div><div class="line">		      <span class="keyword">case</span> lists:keymember(AppName, <span class="number">1</span>, Running) <span class="keyword">of</span></div><div class="line">			  <span class="literal">true</span> -&gt;</div><div class="line">			      ok;</div><div class="line">			  <span class="literal">false</span> -&gt;</div><div class="line">			      throw(&#123;info, &#123;not_running, AppName&#125;&#125;)</div><div class="line">		      <span class="keyword">end</span></div><div class="line">	      <span class="keyword">end</span>, Appl#appl.apps),</div><div class="line"><span class="comment">%% 启动application的master程序和application的监控树</span></div><div class="line">	    <span class="keyword">case</span> application_master:start_link(ApplData, Type) <span class="keyword">of</span></div><div class="line">		&#123;ok, _Pid&#125; = Ok -&gt;</div><div class="line">		    Ok;</div><div class="line">		&#123;error, _Reason&#125; = Error -&gt;</div><div class="line">		    throw(Error)</div><div class="line">	    <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span>.</div></pre></td></tr></table></figure></p>
<p>从源码中可以看到application_controller主要的作用就是控制所有applications的启动重启和关闭,监控着所有的applications。通过sys:get_state来看看application_controller的state。<br><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="number">8</span>&gt; rr(<span class="string">"/usr/local/Cellar/erlang/19.3/lib/erlang/lib/kernel-5.2/src/application_controller.erl"</span>).</div><div class="line">[appl,appl_data,state]</div><div class="line"><span class="number">9</span>&gt; </div><div class="line"><span class="number">9</span>&gt; sys:get_state(application_controller).</div><div class="line">#state&#123;loading = [],starting = [],start_p_false = [],</div><div class="line">       running = [&#123;ch_app,&lt;<span class="number">0.73</span>.<span class="number">0</span>&gt;&#125;,</div><div class="line">                  &#123;sasl,&lt;<span class="number">0.64</span>.<span class="number">0</span>&gt;&#125;,</div><div class="line">                  &#123;stdlib,undefined&#125;,</div><div class="line">                  &#123;kernel,&lt;<span class="number">0.35</span>.<span class="number">0</span>&gt;&#125;],</div><div class="line">       control = [],</div><div class="line">       started = [&#123;ch_app,temporary&#125;,</div><div class="line">                  &#123;sasl,temporary&#125;,</div><div class="line">                  &#123;stdlib,permanent&#125;,</div><div class="line">                  &#123;kernel,permanent&#125;],</div><div class="line">       start_req = [],conf_data = []&#125;</div></pre></td></tr></table></figure></p>
<p>从stated中可以看到有四个app，ch_app和sasl的app都是temporary而stdlib和kernerl都是permanent这个有什么不一样吗？</p>
<blockquote>
<p>Note:<br>         The RestartType specifies what should happen if theapplication dies:<br>         If it is permanent, all other applications are terminated,  and the application_controller dies.<br>         If it is transient, and the application dies normally,<br>           this is reported and no other applications are terminated.<br>         If the application dies abnormally, all other applicationsare terminated, and the application_controller dies.<br>         If it is temporary and the application dies this is reported and no other applications are terminated.<br>         In this way,an application can run in test mode, without disturbing the other applications.<br>         The caller of this function is suspended until the application<br>         is started, either locally or distributed.</p>
</blockquote>
<p>默认的RestartType是temporary,app退出不会影响别的app。permanent表示app挂掉所有别的app都会退出且application_controller也会退出并且整个node都会崩溃。一般默认就可以了。</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">start_link</span><span class="params">(ApplData, Type)</span> -&gt;</span></div><div class="line">    Parent = whereis(application_controller),</div><div class="line">    proc_lib:start_link(application_master, init,</div><div class="line">			[Parent, self(), ApplData, Type]).</div><div class="line"></div><div class="line"><span class="function"><span class="title">init</span><span class="params">(Parent, Starter, ApplData, Type)</span> -&gt;</span></div><div class="line">    link(Parent),</div><div class="line">    process_flag(trap_exit, true),</div><div class="line">    OldGleader = group_leader(),</div><div class="line">    group_leader(self(), self()),</div><div class="line">    <span class="comment">%% Insert ourselves as master for the process.  This ensures that</span></div><div class="line">    <span class="comment">%% the processes in the application can use get_env/1 at startup.</span></div><div class="line">    Name = ApplData#appl_data.name,</div><div class="line">    ets:insert(ac_tab, &#123;&#123;application_master, Name&#125;, self()&#125;),</div><div class="line">    State = #state&#123;appl_data = ApplData, gleader = OldGleader&#125;,</div><div class="line">    <span class="keyword">case</span> start_it(State, Type) <span class="keyword">of</span></div><div class="line">	&#123;ok, Pid&#125; -&gt;          <span class="comment">% apply(M,F,A) returned ok</span></div><div class="line">	    ok = set_timer(ApplData#appl_data.maxT),</div><div class="line">	    unlink(Starter),</div><div class="line">	    proc_lib:init_ack(Starter, &#123;ok,self()&#125;),</div><div class="line"><span class="comment">%% master main_loop</span></div><div class="line">	    main_loop(Parent, State#state&#123;child = Pid&#125;);</div><div class="line">	&#123;error, Reason&#125; -&gt;    <span class="comment">% apply(M,F,A) returned error</span></div><div class="line">	    exit(Reason);</div><div class="line">	Else -&gt;               <span class="comment">% apply(M,F,A) returned erroneous</span></div><div class="line">	    exit(Else)</div><div class="line">    <span class="keyword">end</span>.</div><div class="line"></div><div class="line"><span class="comment">%%-----------------------------------------------------------------</span></div><div class="line"><span class="comment">%% We want to start the new application synchronously, but we still</span></div><div class="line"><span class="comment">%% want to handle io requests.  So we spawn off a new process that</span></div><div class="line"><span class="comment">%% performs the apply, and we wait for a start ack.</span></div><div class="line"><span class="comment">%%-----------------------------------------------------------------</span></div><div class="line"><span class="function"><span class="title">start_it</span><span class="params">(State, Type)</span> -&gt;</span></div><div class="line">    Tag = make_ref(),</div><div class="line"><span class="comment">%% 启动一下X进程</span></div><div class="line">    Pid = spawn_link(application_master, start_it, [Tag, State, self(), Type]),</div><div class="line">    init_loop(Pid, Tag, State, Type).</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">%%-----------------------------------------------------------------</span></div><div class="line"><span class="comment">%% These are the three different loops executed by the application_</span></div><div class="line"><span class="comment">%% master</span></div><div class="line"><span class="comment">%%-----------------------------------------------------------------</span></div><div class="line"><span class="function"><span class="title">init_loop</span><span class="params">(Pid, Tag, State, Type)</span> -&gt;</span></div><div class="line">    <span class="keyword">receive</span></div><div class="line"> 	IoReq <span class="keyword">when</span> element(<span class="number">1</span>, IoReq) =:= io_request -&gt;</div><div class="line">	    State#state.gleader ! IoReq,</div><div class="line">	    init_loop(Pid, Tag, State, Type);</div><div class="line">	&#123;Tag, Res&#125; -&gt;</div><div class="line">	    Res;</div><div class="line">	&#123;'EXIT', Pid, Reason&#125; -&gt;</div><div class="line">	    &#123;error, Reason&#125;;</div><div class="line">	&#123;start_type, From&#125; -&gt;</div><div class="line">	    From ! &#123;start_type, Type&#125;,</div><div class="line">	    init_loop(Pid, Tag, State, Type);</div><div class="line">	Other -&gt;</div><div class="line">	    NewState = handle_msg(Other, State),</div><div class="line">	    init_loop(Pid, Tag, NewState, Type)</div><div class="line">    <span class="keyword">end</span>.</div><div class="line"></div><div class="line"><span class="function"><span class="title">main_loop</span><span class="params">(Parent, State)</span> -&gt;</span></div><div class="line">    <span class="keyword">receive</span></div><div class="line">	IoReq <span class="keyword">when</span> element(<span class="number">1</span>, IoReq) =:= io_request -&gt;</div><div class="line">	    State#state.gleader ! IoReq,</div><div class="line">	    main_loop(Parent, State);</div><div class="line">	&#123;'EXIT', Parent, Reason&#125; -&gt;</div><div class="line">	    terminate(Reason, State);</div><div class="line">	&#123;'EXIT', Child, Reason&#125; <span class="keyword">when</span> State#state.child =:= Child -&gt;</div><div class="line">	    terminate(Reason, State#state&#123;child=undefined&#125;);</div><div class="line">	&#123;'EXIT', _, timeout&#125; -&gt;</div><div class="line">	    terminate(normal, State);</div><div class="line">	&#123;'EXIT', Pid, _Reason&#125; -&gt;</div><div class="line">	    Children = lists:delete(Pid, State#state.children),</div><div class="line">	    Procs = State#state.procs - <span class="number">1</span>,</div><div class="line">	    main_loop(Parent, State#state&#123;children=Children, procs=Procs&#125;);</div><div class="line">	&#123;start_type, From&#125; -&gt;</div><div class="line">	    From ! &#123;start_type, local&#125;,</div><div class="line">	    main_loop(Parent, State);</div><div class="line">	Other -&gt;</div><div class="line">	    NewState = handle_msg(Other, State),</div><div class="line">	    main_loop(Parent, NewState)</div><div class="line">    <span class="keyword">end</span>.</div><div class="line"></div><div class="line"><span class="function"><span class="title">terminate_loop</span><span class="params">(Child, State)</span> -&gt;</span></div><div class="line">    <span class="keyword">receive</span></div><div class="line"> 	IoReq <span class="keyword">when</span> element(<span class="number">1</span>, IoReq) =:= io_request -&gt;</div><div class="line">	    State#state.gleader ! IoReq,</div><div class="line">	    terminate_loop(Child, State);</div><div class="line">	&#123;'EXIT', Child, _&#125; -&gt;</div><div class="line">	    ok;</div><div class="line">	Other -&gt;</div><div class="line">	    NewState = handle_msg(Other, State),</div><div class="line">	    terminate_loop(Child, NewState)</div><div class="line">    <span class="keyword">end</span>.</div></pre></td></tr></table></figure>
<p>从上面的代码可以看到application_master:start_link()后创建了一个X进程，X进程负责启动ch_app:start(_Type,_Args)。X进程的作用相当于是一个代理进程，负责AM进程和底层进程的交互。为什么AM进程不直接启动底层的进程而是要增加一个X进程。我们看一下代码中的注释。</p>
<blockquote>
<p>Note:<br> The logical and physical process structrure is as follows:<br>         logical                physical</p>
<pre><code>--------               --------
|AM(GL)|               |AM(GL)|               
--------               -------- 
   |                       |
--------               --------
|Appl P|               |   X  |
--------               --------
                           |
                       --------
                       |Appl P|
                       --------
</code></pre><p> Where AM(GL) == Application Master (Group Leader)<br>       Appl P == The application specific root process (child to AM)<br>       X      == A special ‘invisible’ process<br> The reason for not using the logical structrure is that<br> the application start function is synchronous, and<br> that the AM is GL.  This means that if AM executed the start<br> function, and this function uses io, deadlock would occur.<br> Therefore, this function is executed by the process X.<br> Also, AM needs three loops;<br> init_loop (waiting for the start function to return)<br> main_loop<br> terminate_loop (waiting for the process to die)<br> In each of these loops, io and other requests are handled.</p>
</blockquote>
<p>理由是AM作为一个group leader进程需要实时处理io的相关请求，所以不能做同步的处理，而启动子进程需要同步处理，如果在AM进程处理会造成死锁。因为如果启动子进程的方法里面有io相关的操作，而io相关的处理需要发送到io进程的group leader且是同步的，而AM就是io进程的group leader，所以会出现io等待AM，而AM又在等待io，所以会出现死锁。从application_master的init_loop、main_loop、terminate_loop中可以看到每个recevie中都有下面接收IoReq的消息并往存在state中的erlang:group_leader()进程发送。从这里可以发现io发送的消息最终会到达group_leader()的进程。group_leader与io的关系我们下次开一个章节再讨论吧。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">receive</div><div class="line">	IoReq when element(1, IoReq) =:= io_request -&gt;</div><div class="line">    State#state.gleader ! IoReq,</div></pre></td></tr></table></figure></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>1.整棵监控树应该是这样的：application_controller -&gt; AM(0.73.0) -&gt; X(0.74.0) -&gt; Appl P(ch_sup_sup) -&gt; Other<br>2.X的作用就是代理进程，防止死锁<br>3.io:format()会把消息发送给AM,AM再发送给erlang:group_leader().<br>4.temperory启动的app，terminated不会影响别的app。permanent启动的app terminated所有app都terminate且vm退出.<br>5.问题：application_controller由什么进程监控,如何启动的?<br>6.问题：io:format()是怎么样输出到shell的？</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/16/let-supervisor-crash-md/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Cameron">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Amazing Erlang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/16/let-supervisor-crash-md/" itemprop="url">动手搞死supervisor</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-16T19:02:44+08:00">
                2017-10-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Erlang基础知识/" itemprop="url" rel="index">
                    <span itemprop="name">Erlang基础知识</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="supervisor是什么"><a href="#supervisor是什么" class="headerlink" title="supervisor是什么?"></a>supervisor是什么?</h3><p>不解释在这里，<a href="http://erlang.org/docs/" target="_blank" rel="external">Supervisor Behaviour</a>.在右边搜索框输入supervisor,点击点击就找到了。</p>
<h3 id="启动supervisor"><a href="#启动supervisor" class="headerlink" title="启动supervisor"></a>启动supervisor</h3><p>改一下官网的demo<br><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">-module</span><span class="params">(ch_sup)</span>.</div><div class="line"><span class="keyword">-behaviour</span><span class="params">(supervisor)</span>.</div><div class="line"></div><div class="line"><span class="keyword">-export</span><span class="params">([start_link/<span class="number">0</span>])</span>.</div><div class="line"><span class="keyword">-export</span><span class="params">([init/<span class="number">1</span>])</span>.</div><div class="line"><span class="keyword">-export</span><span class="params">([new_process/<span class="number">0</span>])</span>.</div><div class="line"></div><div class="line"><span class="function"><span class="title">start_link</span><span class="params">()</span> -&gt;</span></div><div class="line">    supervisor:start_link(ch_sup, []).</div><div class="line"></div><div class="line"><span class="function"><span class="title">init</span><span class="params">(_Args)</span> -&gt;</span></div><div class="line">    SupFlags = #&#123;strategy =&gt; one_for_one, intensity =&gt; <span class="number">1</span>, period =&gt; <span class="number">5</span>&#125;,</div><div class="line">    ChildSpecs = [#&#123;id =&gt; ch3,</div><div class="line">                    start =&gt; &#123;ch_sup, new_process, []&#125;,</div><div class="line">                    restart =&gt; permanent,</div><div class="line">                    shutdown =&gt; brutal_kill,</div><div class="line">                    type =&gt; worker,</div><div class="line">                    modules =&gt; [ch_sup]&#125;],</div><div class="line">    &#123;ok, &#123;SupFlags, ChildSpecs&#125;&#125;.</div><div class="line"><span class="comment">%% 直接在本模块启动一个子进程</span></div><div class="line"><span class="function"><span class="title">new_process</span><span class="params">()</span> -&gt;</span></div><div class="line">  Pid = proc_lib:spawn_link(fun loop/0),</div><div class="line">  &#123;ok, Pid&#125;.</div><div class="line"></div><div class="line"><span class="function"><span class="title">loop</span><span class="params">()</span> -&gt;</span></div><div class="line">  <span class="keyword">receive</span></div><div class="line">    exit -&gt;</div><div class="line">      ok;</div><div class="line">    Msg -&gt;</div><div class="line">      io:format(<span class="string">" self=&gt; ~p, msg=&gt; ~p ~n"</span>,[self(), Msg]),</div><div class="line">     loop()</div><div class="line">  <span class="keyword">end</span>.</div></pre></td></tr></table></figure></p>
<p>启动这个supervisor然后搞死子进程看看发生什么情况。<br><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>&gt; ch_sup:start_link().</div><div class="line">&#123;ok,&lt;<span class="number">0.143</span>.<span class="number">0</span>&gt;&#125;</div><div class="line"><span class="number">2</span>&gt; </div><div class="line">=PROGRESS REPORT==== <span class="number">16</span>-Oct-<span class="number">2017</span>::<span class="number">19</span>:<span class="number">41</span>:<span class="number">40</span> ===</div><div class="line">          supervisor: &#123;&lt;<span class="number">0.143</span>.<span class="number">0</span>&gt;,ch_sup&#125;</div><div class="line">             started: [&#123;pid,&lt;<span class="number">0.144</span>.<span class="number">0</span>&gt;&#125;,</div><div class="line">                       &#123;id,ch3&#125;,</div><div class="line">                       &#123;mfargs,&#123;ch_sup,new_process,[]&#125;&#125;,</div><div class="line">                       &#123;restart_type,permanent&#125;,</div><div class="line">                       &#123;shutdown,brutal_kill&#125;,</div><div class="line">                       &#123;child_type,worker&#125;]</div><div class="line"></div><div class="line"><span class="number">3</span>&gt; erlang:exit(pid(<span class="number">0</span>,<span class="number">144</span>,<span class="number">0</span>),kill).<span class="comment">%% 直接杀死子进程</span></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">4</span>&gt; </div><div class="line">=SUPERVISOR REPORT==== <span class="number">16</span>-Oct-<span class="number">2017</span>::<span class="number">19</span>:<span class="number">42</span>:<span class="number">48</span> ===</div><div class="line">     Supervisor: &#123;&lt;<span class="number">0.143</span>.<span class="number">0</span>&gt;,ch_sup&#125;</div><div class="line">     Context:    child_terminated</div><div class="line">     Reason:     killed<span class="comment">%% 监控进程收到killed消息</span></div><div class="line">     Offender:   [&#123;pid,&lt;<span class="number">0.144</span>.<span class="number">0</span>&gt;&#125;,</div><div class="line">                  &#123;id,ch3&#125;,</div><div class="line">                  &#123;mfargs,&#123;ch_sup,new_process,[]&#125;&#125;,</div><div class="line">                  &#123;restart_type,permanent&#125;,</div><div class="line">                  &#123;shutdown,brutal_kill&#125;,</div><div class="line">                  &#123;child_type,worker&#125;]</div><div class="line"></div><div class="line"><span class="comment">%% 从新启动一个新的进程</span></div><div class="line">=PROGRESS REPORT==== <span class="number">16</span>-Oct-<span class="number">2017</span>::<span class="number">19</span>:<span class="number">42</span>:<span class="number">48</span> ===</div><div class="line">          supervisor: &#123;&lt;<span class="number">0.143</span>.<span class="number">0</span>&gt;,ch_sup&#125;</div><div class="line">             started: [&#123;pid,&lt;<span class="number">0.147</span>.<span class="number">0</span>&gt;&#125;,</div><div class="line">                       &#123;id,ch3&#125;,</div><div class="line">                       &#123;mfargs,&#123;ch_sup,new_process,[]&#125;&#125;,</div><div class="line">                       &#123;restart_type,permanent&#125;,</div><div class="line">                       &#123;shutdown,brutal_kill&#125;,</div><div class="line">                       &#123;child_type,worker&#125;]</div><div class="line"></div><div class="line"><span class="number">4</span>&gt; erlang:exit(pid(<span class="number">0</span>,<span class="number">147</span>,<span class="number">0</span>),shutdown).<span class="comment">%% 试试发送shutdown</span></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">5</span>&gt; </div><div class="line">=SUPERVISOR REPORT==== <span class="number">16</span>-Oct-<span class="number">2017</span>::<span class="number">19</span>:<span class="number">43</span>:<span class="number">24</span> ===</div><div class="line">     Supervisor: &#123;&lt;<span class="number">0.143</span>.<span class="number">0</span>&gt;,ch_sup&#125;</div><div class="line">     Context:    child_terminated</div><div class="line">     Reason:     shutdown</div><div class="line">     Offender:   [&#123;pid,&lt;<span class="number">0.147</span>.<span class="number">0</span>&gt;&#125;,</div><div class="line">                  &#123;id,ch3&#125;,</div><div class="line">                  &#123;mfargs,&#123;ch_sup,new_process,[]&#125;&#125;,</div><div class="line">                  &#123;restart_type,permanent&#125;,</div><div class="line">                  &#123;shutdown,brutal_kill&#125;,</div><div class="line">                  &#123;child_type,worker&#125;]</div><div class="line"></div><div class="line"><span class="comment">%% 继续重启</span></div><div class="line">=PROGRESS REPORT==== <span class="number">16</span>-Oct-<span class="number">2017</span>::<span class="number">19</span>:<span class="number">43</span>:<span class="number">24</span> ===</div><div class="line">          supervisor: &#123;&lt;<span class="number">0.143</span>.<span class="number">0</span>&gt;,ch_sup&#125;</div><div class="line">             started: [&#123;pid,&lt;<span class="number">0.149</span>.<span class="number">0</span>&gt;&#125;,</div><div class="line">                       &#123;id,ch3&#125;,</div><div class="line">                       &#123;mfargs,&#123;ch_sup,new_process,[]&#125;&#125;,</div><div class="line">                       &#123;restart_type,permanent&#125;,</div><div class="line">                       &#123;shutdown,brutal_kill&#125;,</div><div class="line">                       &#123;child_type,worker&#125;]</div><div class="line"></div><div class="line"><span class="comment">%% 下面快速的连续让子进程两次退出</span></div><div class="line"><span class="number">6</span>&gt; erlang:exit(pid(<span class="number">0</span>,<span class="number">152</span>,<span class="number">0</span>),other).</div><div class="line"></div><div class="line">=SUPERVISOR REPORT==== <span class="number">16</span>-Oct-<span class="number">2017</span>::<span class="number">19</span>:<span class="number">44</span>:<span class="number">11</span> ===</div><div class="line">     Supervisor: &#123;&lt;<span class="number">0.143</span>.<span class="number">0</span>&gt;,ch_sup&#125;</div><div class="line">     Context:    child_terminated</div><div class="line">     Reason:     other</div><div class="line">     Offender:   [&#123;pid,&lt;<span class="number">0.152</span>.<span class="number">0</span>&gt;&#125;,</div><div class="line">                  &#123;id,ch3&#125;,</div><div class="line">                  &#123;mfargs,&#123;ch_sup,new_process,[]&#125;&#125;,</div><div class="line">                  &#123;restart_type,permanent&#125;,</div><div class="line">                  &#123;shutdown,brutal_kill&#125;,</div><div class="line">                  &#123;child_type,worker&#125;]</div><div class="line"><span class="comment">%% 第一次重启了</span></div><div class="line">=PROGRESS REPORT==== <span class="number">16</span>-Oct-<span class="number">2017</span>::<span class="number">19</span>:<span class="number">44</span>:<span class="number">11</span> ===</div><div class="line">          supervisor: &#123;&lt;<span class="number">0.143</span>.<span class="number">0</span>&gt;,ch_sup&#125;</div><div class="line">             started: [&#123;pid,&lt;<span class="number">0.154</span>.<span class="number">0</span>&gt;&#125;,</div><div class="line">                       &#123;id,ch3&#125;,</div><div class="line">                       &#123;mfargs,&#123;ch_sup,new_process,[]&#125;&#125;,</div><div class="line">                       &#123;restart_type,permanent&#125;,</div><div class="line">                       &#123;shutdown,brutal_kill&#125;,</div><div class="line">                       &#123;child_type,worker&#125;]</div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">7</span>&gt; erlang:exit(pid(<span class="number">0</span>,<span class="number">154</span>,<span class="number">0</span>),other).</div><div class="line"></div><div class="line">=SUPERVISOR REPORT==== <span class="number">16</span>-Oct-<span class="number">2017</span>::<span class="number">19</span>:<span class="number">44</span>:<span class="number">15</span> ===</div><div class="line">     Supervisor: &#123;&lt;<span class="number">0.143</span>.<span class="number">0</span>&gt;,ch_sup&#125;</div><div class="line">     Context:    child_terminated</div><div class="line">     Reason:     other</div><div class="line">     Offender:   [&#123;pid,&lt;<span class="number">0.154</span>.<span class="number">0</span>&gt;&#125;,</div><div class="line">                  &#123;id,ch3&#125;,</div><div class="line">                  &#123;mfargs,&#123;ch_sup,new_process,[]&#125;&#125;,</div><div class="line">                  &#123;restart_type,permanent&#125;,</div><div class="line">                  &#123;shutdown,brutal_kill&#125;,</div><div class="line">                  &#123;child_type,worker&#125;]</div><div class="line"></div><div class="line"><span class="comment">%% 第二次supervisor也shutdown了</span></div><div class="line">=SUPERVISOR REPORT==== <span class="number">16</span>-Oct-<span class="number">2017</span>::<span class="number">19</span>:<span class="number">44</span>:<span class="number">15</span> ===</div><div class="line">     Supervisor: &#123;&lt;<span class="number">0.143</span>.<span class="number">0</span>&gt;,ch_sup&#125;</div><div class="line">     Context:    shutdown</div><div class="line">     Reason:     reached_max_restart_intensity</div><div class="line">     Offender:   [&#123;pid,&lt;<span class="number">0.154</span>.<span class="number">0</span>&gt;&#125;,</div><div class="line">                  &#123;id,ch3&#125;,</div><div class="line">                  &#123;mfargs,&#123;ch_sup,new_process,[]&#125;&#125;,</div><div class="line">                  &#123;restart_type,permanent&#125;,</div><div class="line">                  &#123;shutdown,brutal_kill&#125;,</div><div class="line">                  &#123;child_type,worker&#125;]</div><div class="line"></div><div class="line">** exception exit: shutdown<span class="comment">%% shell收到supervisor的shutdown退出消息</span></div><div class="line"><span class="number">8</span>&gt;</div></pre></td></tr></table></figure></p>
<p>5秒内最大重启次数为一次，我们刚才在5内重启了两次。所以,<br>supervisor自己也退出了。看看官网的解释<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">If more than MaxR number of restarts occur in the last MaxT seconds, </div><div class="line">the supervisor terminates all the child processes and then itself. </div><div class="line">The termination reason for the supervisor itself in that case will be shutdown.</div></pre></td></tr></table></figure></p>
<p>再来看看supervisor子进程重启次数超过阀值的逻辑代码<br><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">add_restart</span><span class="params">(State)</span> -&gt;</span>  </div><div class="line">    I = State#state.intensity,</div><div class="line">    P = State#state.period,</div><div class="line">    R = State#state.restarts,</div><div class="line">    Now = erlang:monotonic_time(<span class="number">1</span>),</div><div class="line">    R1 = add_restart([Now|R], Now, P),</div><div class="line">    State1 = State#state&#123;restarts = R1&#125;,</div><div class="line">    <span class="keyword">case</span> length(R1) <span class="keyword">of</span></div><div class="line">	CurI <span class="keyword">when</span> CurI  =&lt; I -&gt;</div><div class="line">	    &#123;ok, State1&#125;;</div><div class="line">	_ -&gt;</div><div class="line">	    &#123;terminate, State1&#125;</div><div class="line">    <span class="keyword">end</span>.</div><div class="line"><span class="comment">%% period内重启次数超过intensity就terminate监控进程</span></div><div class="line"><span class="function"><span class="title">add_restart</span><span class="params">([R|Restarts], Now, Period)</span> -&gt;</span></div><div class="line">    <span class="keyword">case</span> inPeriod(R, Now, Period) <span class="keyword">of</span></div><div class="line">	<span class="literal">true</span> -&gt;</div><div class="line">	    [R|add_restart(Restarts, Now, Period)];</div><div class="line">	_ -&gt;</div><div class="line">	    []</div><div class="line">    <span class="keyword">end</span>;</div><div class="line"><span class="function"><span class="title">add_restart</span><span class="params">([], _, _)</span> -&gt;</span></div><div class="line">    [].</div><div class="line"></div><div class="line"><span class="function"><span class="title">inPeriod</span><span class="params">(Then, Now, Period)</span> -&gt;</span></div><div class="line">    Now =&lt; Then + Period.</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="title">restart</span><span class="params">(Child, State)</span> -&gt;</span></div><div class="line">    <span class="keyword">case</span> add_restart(State) <span class="keyword">of</span></div><div class="line">	&#123;ok, NState&#125; -&gt;</div><div class="line">	    <span class="keyword">case</span> restart(NState#state.strategy, Child, NState) <span class="keyword">of</span></div><div class="line">		&#123;try_again,NState2&#125; -&gt;</div><div class="line">		    <span class="comment">%% Leaving control back to gen_server before</span></div><div class="line">		    <span class="comment">%% trying again. This way other incoming requsts</span></div><div class="line">		    <span class="comment">%% for the supervisor can be handled - e.g. a</span></div><div class="line">		    <span class="comment">%% shutdown request for the supervisor or the</span></div><div class="line">		    <span class="comment">%% child.</span></div><div class="line">		    Id = <span class="keyword">if</span> ?is_simple(State) -&gt; Child#child.pid;</div><div class="line">			    <span class="literal">true</span> -&gt; Child#child.name</div><div class="line">			 <span class="keyword">end</span>,</div><div class="line">		    ok = try_again_restart(self(), Id),</div><div class="line">		    &#123;ok,NState2&#125;;</div><div class="line">		&#123;try_again, NState2, #child&#123;name=ChName&#125;&#125; -&gt;</div><div class="line">		    ok = try_again_restart(self(), ChName),</div><div class="line">		    &#123;ok,NState2&#125;;</div><div class="line">		Other -&gt;</div><div class="line">		    Other</div><div class="line">	    <span class="keyword">end</span>;</div><div class="line">	&#123;terminate, NState&#125; -&gt;</div><div class="line">	    report_error(shutdown, reached_max_restart_intensity,</div><div class="line">			 Child, State#state.name),</div><div class="line">              <span class="comment">%% 移除所有子进程</span></div><div class="line">	    &#123;shutdown, remove_child(Child, NState)&#125;</div><div class="line">    <span class="keyword">end</span>.</div><div class="line"></div><div class="line"><span class="function"><span class="title">handle_cast</span><span class="params">(&#123;try_again_restart,Pid&#125;, #state&#123;children=[Child]&#125;=State)</span></span></div><div class="line"><span class="function">  <span class="title">when</span> ?<span class="title">is_simple</span><span class="params">(State)</span> -&gt;</span></div><div class="line">    RT = Child#child.restart_type,</div><div class="line">    RPid = restarting(Pid),</div><div class="line">    <span class="keyword">case</span> dynamic_child_args(RPid, RT, State#state.dynamics) <span class="keyword">of</span></div><div class="line">	&#123;ok, Args&#125; -&gt;</div><div class="line">	    &#123;M, F, _&#125; = Child#child.mfargs,</div><div class="line">	    NChild = Child#child&#123;pid = RPid, mfargs = &#123;M, F, Args&#125;&#125;,</div><div class="line">	    <span class="keyword">case</span> restart(NChild,State) <span class="keyword">of</span></div><div class="line">		&#123;ok, State1&#125; -&gt;</div><div class="line">		    &#123;noreply, State1&#125;;</div><div class="line">                <span class="comment">%% stop监控进程</span></div><div class="line">		&#123;shutdown, State1&#125; -&gt;</div><div class="line">		    &#123;stop, shutdown, State1&#125;</div><div class="line">	    <span class="keyword">end</span>;</div><div class="line">	error -&gt;</div><div class="line">            &#123;noreply, State&#125;</div><div class="line">    <span class="keyword">end</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="title">handle_cast</span><span class="params">(&#123;try_again_restart,Name&#125;, State)</span> -&gt;</span></div><div class="line">    <span class="keyword">case</span> lists:keyfind(Name,#child.name,State#state.children) <span class="keyword">of</span></div><div class="line">	Child = #child&#123;pid=?restarting(_)&#125; -&gt;</div><div class="line">	    <span class="keyword">case</span> restart(Child,State) <span class="keyword">of</span></div><div class="line">		&#123;ok, State1&#125; -&gt;</div><div class="line">		    &#123;noreply, State1&#125;;</div><div class="line">                <span class="comment">%% stop监控进程</span></div><div class="line">		&#123;shutdown, State1&#125; -&gt;</div><div class="line">		    &#123;stop, shutdown, State1&#125;</div><div class="line">	    <span class="keyword">end</span>;</div><div class="line">	_ -&gt;</div><div class="line">	    &#123;noreply,State&#125;</div><div class="line">    <span class="keyword">end</span>.</div><div class="line"></div><div class="line"><span class="comment">%% 看看terminate做了什么事情</span></div><div class="line"><span class="function"><span class="title">terminate</span><span class="params">(_Reason, #state&#123;children=[Child]&#125; = State)</span> <span class="title">when</span> ?<span class="title">is_simple</span><span class="params">(State)</span> -&gt;</span></div><div class="line">    terminate_dynamic_children(Child, dynamics_db(Child#child.restart_type,</div><div class="line">                                                  State#state.dynamics),</div><div class="line">                               State#state.name);</div><div class="line"><span class="function"><span class="title">terminate</span><span class="params">(_Reason, State)</span> -&gt;</span></div><div class="line">    terminate_children(State#state.children, State#state.name).</div><div class="line"></div><div class="line"><span class="comment">%% simple_one_for_one的退出方式</span></div><div class="line"><span class="comment">%% 基本是同时向别的子进程发送exit消息</span></div><div class="line"><span class="comment">%% 如果子进程为gen_server且没有设置trap_exit那么</span></div><div class="line"><span class="comment">%% 子进程的terminate函数是不会执行的，在terminate需要做</span></div><div class="line"><span class="comment">%% 逻辑处理要特别小心</span></div><div class="line"><span class="function"><span class="title">terminate_dynamic_children</span><span class="params">(Child, Dynamics, SupName)</span> -&gt;</span></div><div class="line">    &#123;Pids, EStack0&#125; = monitor_dynamic_children(Child, Dynamics),</div><div class="line">    Sz = ?SETS:size(Pids),</div><div class="line">    EStack = <span class="keyword">case</span> Child#child.shutdown <span class="keyword">of</span></div><div class="line">                 brutal_kill -&gt;</div><div class="line">                     ?SETS:fold(<span class="keyword">fun</span>(P, _) -&gt; exit(P, kill) <span class="keyword">end</span>, ok, Pids),</div><div class="line">                     wait_dynamic_children(Child, Pids, Sz, undefined, EStack0);</div><div class="line">                 infinity -&gt;</div><div class="line">                     ?SETS:fold(<span class="keyword">fun</span>(P, _) -&gt; exit(P, shutdown) <span class="keyword">end</span>, ok, Pids),</div><div class="line">                     wait_dynamic_children(Child, Pids, Sz, undefined, EStack0);</div><div class="line">                 Time -&gt;</div><div class="line">                     ?SETS:fold(<span class="keyword">fun</span>(P, _) -&gt; exit(P, shutdown) <span class="keyword">end</span>, ok, Pids),</div><div class="line">                     TRef = erlang:start_timer(Time, self(), kill),</div><div class="line">                     wait_dynamic_children(Child, Pids, Sz, TRef, EStack0)</div><div class="line">             <span class="keyword">end</span>,</div><div class="line">    <span class="comment">%% Unroll stacked errors and report them</span></div><div class="line">    ?DICTS:fold(<span class="keyword">fun</span>(Reason, Ls, _) -&gt;</div><div class="line">                       report_error(shutdown_error, Reason,</div><div class="line">                                    Child#child&#123;pid=Ls&#125;, SupName)</div><div class="line">               <span class="keyword">end</span>, ok, EStack).</div><div class="line"></div><div class="line"><span class="comment">%% 再看看别的重启策略的退出方式</span></div><div class="line"><span class="comment">%% 可以看到退出的逻辑是一个接一个的退出</span></div><div class="line"><span class="function"><span class="title">terminate_children</span><span class="params">([Child = #child&#123;restart_type=temporary&#125; | Children], SupName, Res)</span> -&gt;</span></div><div class="line">    _ = do_terminate(Child, SupName),</div><div class="line">    terminate_children(Children, SupName, Res);</div><div class="line"><span class="function"><span class="title">terminate_children</span><span class="params">([Child | Children], SupName, Res)</span> -&gt;</span></div><div class="line">    NChild = do_terminate(Child, SupName),</div><div class="line">    terminate_children(Children, SupName, [NChild | Res]);</div><div class="line"><span class="function"><span class="title">terminate_children</span><span class="params">([], _SupName, Res)</span> -&gt;</span></div><div class="line">    Res.</div><div class="line"></div><div class="line"><span class="function"><span class="title">do_terminate</span><span class="params">(Child, SupName)</span> <span class="title">when</span> <span class="title">is_pid</span><span class="params">(Child#child.pid)</span> -&gt;</span></div><div class="line">    <span class="keyword">case</span> shutdown(Child#child.pid, Child#child.shutdown) <span class="keyword">of</span></div><div class="line">        ok -&gt;</div><div class="line">            ok;</div><div class="line">        &#123;error, normal&#125; <span class="keyword">when</span> Child#child.restart_type =/= permanent -&gt;</div><div class="line">            ok;</div><div class="line">        &#123;error, OtherReason&#125; -&gt;</div><div class="line">            report_error(shutdown_error, OtherReason, Child, SupName)</div><div class="line">    <span class="keyword">end</span>,</div><div class="line">    Child#child&#123;pid = undefined&#125;;</div><div class="line"><span class="function"><span class="title">do_terminate</span><span class="params">(Child, _SupName)</span> -&gt;</span></div><div class="line">    Child#child&#123;pid = undefined&#125;.</div><div class="line"><span class="function"><span class="title">shutdown</span><span class="params">(Pid, brutal_kill)</span> -&gt;</span></div><div class="line">    <span class="keyword">case</span> monitor_child(Pid) <span class="keyword">of</span></div><div class="line">	ok -&gt;</div><div class="line">	    exit(Pid, kill),</div><div class="line">	    <span class="keyword">receive</span></div><div class="line">		&#123;'DOWN', _MRef, process, Pid, killed&#125; -&gt;</div><div class="line">		    ok;</div><div class="line">		&#123;'DOWN', _MRef, process, Pid, OtherReason&#125; -&gt;</div><div class="line">		    &#123;error, OtherReason&#125;</div><div class="line">	    <span class="keyword">end</span>;</div><div class="line">	&#123;error, Reason&#125; -&gt;      </div><div class="line">	    &#123;error, Reason&#125;</div><div class="line">    <span class="keyword">end</span>;</div><div class="line"><span class="function"><span class="title">shutdown</span><span class="params">(Pid, Time)</span> -&gt;</span></div><div class="line">    <span class="keyword">case</span> monitor_child(Pid) <span class="keyword">of</span></div><div class="line">	ok -&gt;</div><div class="line">	    exit(Pid, shutdown), <span class="comment">%% Try to shutdown gracefully</span></div><div class="line">	    <span class="keyword">receive</span> </div><div class="line">		&#123;'DOWN', _MRef, process, Pid, shutdown&#125; -&gt;</div><div class="line">		    ok;</div><div class="line">		&#123;'DOWN', _MRef, process, Pid, OtherReason&#125; -&gt;</div><div class="line">		    &#123;error, OtherReason&#125;</div><div class="line">	    <span class="keyword">after</span> Time -&gt;</div><div class="line">		    exit(Pid, kill),  <span class="comment">%% Force termination.</span></div><div class="line">		    <span class="keyword">receive</span></div><div class="line">			&#123;'DOWN', _MRef, process, Pid, OtherReason&#125; -&gt;</div><div class="line">			    &#123;error, OtherReason&#125;</div><div class="line">		    <span class="keyword">end</span></div><div class="line">	    <span class="keyword">end</span>;</div><div class="line">	&#123;error, Reason&#125; -&gt;      </div><div class="line">	    &#123;error, Reason&#125;</div><div class="line">    <span class="keyword">end</span>.</div></pre></td></tr></table></figure></p>
<h3 id="ch-sup的前面再加一层supervisor"><a href="#ch-sup的前面再加一层supervisor" class="headerlink" title="ch_sup的前面再加一层supervisor"></a>ch_sup的前面再加一层supervisor</h3><p>修改一下代码,在一个模块里启动master<br>顶层supervisor，ch_sup为master的child,<br>验证监控树的最底层发送异常是否会影响到上层的，<br>监控进程。<br><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">-module</span><span class="params">(ch_sup)</span>.</div><div class="line"><span class="keyword">-behaviour</span><span class="params">(supervisor)</span>.</div><div class="line"></div><div class="line"><span class="keyword">-export</span><span class="params">([start_link/<span class="number">2</span>])</span>.</div><div class="line"><span class="keyword">-export</span><span class="params">([init/<span class="number">1</span>])</span>.</div><div class="line"><span class="keyword">-export</span><span class="params">([new_process/<span class="number">0</span>])</span>.</div><div class="line"></div><div class="line"><span class="function"><span class="title">start_link</span><span class="params">(Sup, Type)</span> -&gt;</span></div><div class="line">    supervisor:start_link(&#123;local, Sup&#125;, ?MODULE, [Type]).</div><div class="line"><span class="comment">%% master的supervisor策略</span></div><div class="line"><span class="function"><span class="title">init</span><span class="params">([master])</span> -&gt;</span></div><div class="line">  SupFlags = #&#123;strategy =&gt; one_for_one, intensity =&gt; <span class="number">1</span>, period =&gt; <span class="number">5</span>&#125;,</div><div class="line">    ChildSpecs = [#&#123;id =&gt; ch3,</div><div class="line">                    start =&gt; &#123;ch_sup, start_link, [?MODULE, child]&#125;,</div><div class="line">                    restart =&gt; permanent,</div><div class="line">                    shutdown =&gt; brutal_kill,</div><div class="line">                    type =&gt; supervisor,</div><div class="line">                    modules =&gt; [ch_sup]&#125;],</div><div class="line">    &#123;ok, &#123;SupFlags, ChildSpecs&#125;&#125;;</div><div class="line">  init(_Args) -&gt;</div><div class="line">    <span class="comment">%% 设置worker不能重启方便验证master对ch_sup进程退出的处理</span></div><div class="line">    SupFlags = #&#123;strategy =&gt; one_for_one, intensity =&gt; <span class="number">0</span>, period =&gt; <span class="number">5</span>&#125;,</div><div class="line">    ChildSpecs = [#&#123;id =&gt; ch3,</div><div class="line">                    start =&gt; &#123;ch_sup, new_process, []&#125;,</div><div class="line">                    restart =&gt; permanent,</div><div class="line">                    shutdown =&gt; brutal_kill,</div><div class="line">                    type =&gt; worker,</div><div class="line">                    modules =&gt; [ch_sup]&#125;],</div><div class="line">    &#123;ok, &#123;SupFlags, ChildSpecs&#125;&#125;.</div><div class="line"></div><div class="line"><span class="function"><span class="title">new_process</span><span class="params">()</span> -&gt;</span></div><div class="line">  Pid = proc_lib:spawn_link(fun loop/0),</div><div class="line">  &#123;ok, Pid&#125;.</div><div class="line"></div><div class="line"><span class="function"><span class="title">loop</span><span class="params">()</span> -&gt;</span></div><div class="line">  <span class="keyword">receive</span></div><div class="line">    exit -&gt;</div><div class="line">      ok;</div><div class="line">    Msg -&gt;</div><div class="line">      io:format(<span class="string">" self=&gt; ~p, msg=&gt; ~p ~n"</span>,[self(), Msg]),</div><div class="line">     loop()</div><div class="line">  <span class="keyword">end</span>.</div></pre></td></tr></table></figure></p>
<p>通过下面的验证我们可以发现底层的进程发送异常退出是影响到<br>上层的supervisor的。看看下面官方的说明<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">For example, if the top level allows 10 restarts, and the next level also allows 10, </div><div class="line">a crashing child below that level will be restarted 100 times, which is probably </div><div class="line">excessive. Allowing at most 3 restarts for the top level supervisor might be a</div><div class="line"> better choice in this case.</div></pre></td></tr></table></figure></p>
<p>官方的意思是有A-&gt;B-&gt;C三个进程A是top的supervisor。<br>B是C的supervisor。那么如果C允许重启次数为10，<br>B允许重启次数为10，那么整个监控树crash需要<br>C重启的次数为100次。所以设计最大重启次数需要<br>根据上下文。下面我们来一步步进行验证<br><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="comment">%% 启动master</span></div><div class="line"><span class="number">1</span>&gt; ch_sup:start_link(master,master).</div><div class="line"><span class="comment">%% 启动最底层的worker</span></div><div class="line">=PROGRESS REPORT==== <span class="number">16</span>-Oct-<span class="number">2017</span>::<span class="number">21</span>:<span class="number">19</span>:<span class="number">33</span> ===</div><div class="line">          supervisor: &#123;local,ch_sup&#125;</div><div class="line">             started: [&#123;pid,&lt;<span class="number">0.145</span>.<span class="number">0</span>&gt;&#125;,</div><div class="line">                       &#123;id,ch3&#125;,</div><div class="line">                       &#123;mfargs,&#123;ch_sup,new_process,[]&#125;&#125;,</div><div class="line">                       &#123;restart_type,permanent&#125;,</div><div class="line">                       &#123;shutdown,brutal_kill&#125;,</div><div class="line">                       &#123;child_type,worker&#125;]</div><div class="line"><span class="comment">%% 启动ch_sup</span></div><div class="line">=PROGRESS REPORT==== <span class="number">16</span>-Oct-<span class="number">2017</span>::<span class="number">21</span>:<span class="number">19</span>:<span class="number">33</span> ===</div><div class="line">          supervisor: &#123;local,master&#125;</div><div class="line">             started: [&#123;pid,&lt;<span class="number">0.144</span>.<span class="number">0</span>&gt;&#125;,</div><div class="line">                       &#123;id,ch3&#125;,</div><div class="line">                       &#123;mfargs,&#123;ch_sup,start_link,[ch_sup,child]&#125;&#125;,</div><div class="line">                       &#123;restart_type,permanent&#125;,</div><div class="line">                       &#123;shutdown,brutal_kill&#125;,</div><div class="line">                       &#123;child_type,supervisor&#125;]</div><div class="line">&#123;ok,&lt;<span class="number">0.143</span>.<span class="number">0</span>&gt;&#125;</div><div class="line"><span class="number">2</span>&gt; supervisor:which_children(master).</div><div class="line">[&#123;ch3,&lt;<span class="number">0.144</span>.<span class="number">0</span>&gt;,supervisor,[ch_sup]&#125;]</div><div class="line"><span class="number">3</span>&gt; supervisor:which_children(ch_sup).</div><div class="line">[&#123;ch3,&lt;<span class="number">0.145</span>.<span class="number">0</span>&gt;,worker,[ch_sup]&#125;]</div><div class="line"><span class="comment">%% kill 掉worker</span></div><div class="line"><span class="number">4</span>&gt; erlang:exit(pid(<span class="number">0</span>,<span class="number">145</span>,<span class="number">0</span>),kill).</div><div class="line"><span class="comment">%% ch_sup收到killed</span></div><div class="line">=SUPERVISOR REPORT==== <span class="number">16</span>-Oct-<span class="number">2017</span>::<span class="number">21</span>:<span class="number">20</span>:<span class="number">36</span> ===</div><div class="line">     Supervisor: &#123;local,ch_sup&#125;</div><div class="line">     Context:    child_terminated</div><div class="line">     Reason:     killed</div><div class="line">     Offender:   [&#123;pid,&lt;<span class="number">0.145</span>.<span class="number">0</span>&gt;&#125;,</div><div class="line">                  &#123;id,ch3&#125;,</div><div class="line">                  &#123;mfargs,&#123;ch_sup,new_process,[]&#125;&#125;,</div><div class="line">                  &#123;restart_type,permanent&#125;,</div><div class="line">                  &#123;shutdown,brutal_kill&#125;,</div><div class="line">                  &#123;child_type,worker&#125;]</div><div class="line"></div><div class="line"><span class="comment">%% 子进程达到最大重试次数ch_sup自己shutdown</span></div><div class="line">=SUPERVISOR REPORT==== <span class="number">16</span>-Oct-<span class="number">2017</span>::<span class="number">21</span>:<span class="number">20</span>:<span class="number">36</span> ===</div><div class="line">     Supervisor: &#123;local,ch_sup&#125;</div><div class="line">     Context:    shutdown</div><div class="line">     Reason:     reached_max_restart_intensity</div><div class="line">     Offender:   [&#123;pid,&lt;<span class="number">0.145</span>.<span class="number">0</span>&gt;&#125;,</div><div class="line">                  &#123;id,ch3&#125;,</div><div class="line">                  &#123;mfargs,&#123;ch_sup,new_process,[]&#125;&#125;,</div><div class="line">                  &#123;restart_type,permanent&#125;,</div><div class="line">                  &#123;shutdown,brutal_kill&#125;,</div><div class="line">                  &#123;child_type,worker&#125;]</div><div class="line"></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="comment">%% master收到ch_sup shutdown消息</span></div><div class="line">=SUPERVISOR REPORT==== <span class="number">16</span>-Oct-<span class="number">2017</span>::<span class="number">21</span>:<span class="number">20</span>:<span class="number">36</span> ===</div><div class="line">     Supervisor: &#123;local,master&#125;</div><div class="line">     Context:    child_terminated</div><div class="line">     Reason:     shutdown</div><div class="line">     Offender:   [&#123;pid,&lt;<span class="number">0.144</span>.<span class="number">0</span>&gt;&#125;,</div><div class="line">                  &#123;id,ch3&#125;,</div><div class="line">                  &#123;mfargs,&#123;ch_sup,start_link,[ch_sup,child]&#125;&#125;,</div><div class="line">                  &#123;restart_type,permanent&#125;,</div><div class="line">                  &#123;shutdown,brutal_kill&#125;,</div><div class="line">                  &#123;child_type,supervisor&#125;]</div><div class="line"></div><div class="line"><span class="comment">%% 重启worker</span></div><div class="line">=PROGRESS REPORT==== <span class="number">16</span>-Oct-<span class="number">2017</span>::<span class="number">21</span>:<span class="number">20</span>:<span class="number">36</span> ===</div><div class="line">          supervisor: &#123;local,ch_sup&#125;</div><div class="line">             started: [&#123;pid,&lt;<span class="number">0.150</span>.<span class="number">0</span>&gt;&#125;,</div><div class="line">                       &#123;id,ch3&#125;,</div><div class="line">                       &#123;mfargs,&#123;ch_sup,new_process,[]&#125;&#125;,</div><div class="line">                       &#123;restart_type,permanent&#125;,</div><div class="line">                       &#123;shutdown,brutal_kill&#125;,</div><div class="line">                       &#123;child_type,worker&#125;]</div><div class="line"><span class="number">5</span>&gt; </div><div class="line"><span class="comment">%% 重启ch_sup</span></div><div class="line">=PROGRESS REPORT==== <span class="number">16</span>-Oct-<span class="number">2017</span>::<span class="number">21</span>:<span class="number">20</span>:<span class="number">36</span> ===</div><div class="line">          supervisor: &#123;local,master&#125;</div><div class="line">             started: [&#123;pid,&lt;<span class="number">0.149</span>.<span class="number">0</span>&gt;&#125;,</div><div class="line">                       &#123;id,ch3&#125;,</div><div class="line">                       &#123;mfargs,&#123;ch_sup,start_link,[ch_sup,child]&#125;&#125;,</div><div class="line">                       &#123;restart_type,permanent&#125;,</div><div class="line">                       &#123;shutdown,brutal_kill&#125;,</div><div class="line">                       &#123;child_type,supervisor&#125;]</div></pre></td></tr></table></figure></p>
<h3 id="simple-one-for-one和别的重启策略的区别"><a href="#simple-one-for-one和别的重启策略的区别" class="headerlink" title="simple_one_for_one和别的重启策略的区别"></a>simple_one_for_one和别的重启策略的区别</h3><p>1、启动方式不一样<br>supervisor:start_child(Sup, List)<br>supervisor:start_child(Sup, ChildSpec)<br>2、子进程退出方式不一样<br>3、teminate某个子进程方式不一样<br>supervisor:terminate_child(Sup, Pid)<br>supervisor:terminate_child(Sup, Id)<br>supervisor:delete_child(Sup, Id)</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/15/Erlang-monitor和link/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Cameron">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Amazing Erlang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/15/Erlang-monitor和link/" itemprop="url">Erlang-monitor和link</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-15T15:02:37+08:00">
                2017-10-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Erlang基础知识/" itemprop="url" rel="index">
                    <span itemprop="name">Erlang基础知识</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>学习Erlang的童鞋都知道，erlang是一门高可靠的函数式编程语言。那么它是如何做到的呢？<br>这篇文章就来探讨一下构成erlang高可靠系统的一个很小的部分，也是一个很重要的部分。<br>erlang进程间的监督方式有link和monitor。link方式为两个进程之间相互监督，<br>其中一个进程退出另一个进程也会受到影响。而monitor方式为单方面具有监督权，<br>被监督进程退出监督进程会受到影响，反之则不会受到影响。  </p>
<h3 id="简单的测试"><a href="#简单的测试" class="headerlink" title="简单的测试"></a>简单的测试</h3><h4 id="spawn-link一个新的进程"><a href="#spawn-link一个新的进程" class="headerlink" title="spawn_link一个新的进程"></a>spawn_link一个新的进程</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">-module</span><span class="params">(a)</span>.</div><div class="line"><span class="comment">%% API</span></div><div class="line"><span class="keyword">-export</span><span class="params">([start/<span class="number">0</span>])</span>.</div><div class="line"><span class="function"><span class="title">start</span><span class="params">()</span> -&gt;</span></div><div class="line">  P1 = proc_lib:spawn_link(<span class="keyword">fun</span>() -&gt; loop() <span class="keyword">end</span>),</div><div class="line">  P1.</div><div class="line"></div><div class="line"><span class="function"><span class="title">loop</span><span class="params">()</span> -&gt;</span></div><div class="line">  <span class="keyword">receive</span></div><div class="line">      Msg-&gt;</div><div class="line">       io:format(<span class="string">"receive =&gt; ~p ~n"</span>, [Msg]),</div><div class="line">        loop()</div><div class="line">  <span class="keyword">end</span>.</div></pre></td></tr></table></figure>
<h5 id="验证shell异常退出，P1进程也退出"><a href="#验证shell异常退出，P1进程也退出" class="headerlink" title="验证shell异常退出，P1进程也退出"></a>验证shell异常退出，P1进程也退出</h5><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>&gt; a:start().<span class="comment">%% 启动一个进程根shell进程link在一起</span></div><div class="line">&lt;<span class="number">0.128</span>.<span class="number">0</span>&gt;</div><div class="line"><span class="number">2</span>&gt; <span class="number">1</span>=<span class="number">2</span>.  <span class="comment">%% 使shell进程异常退出 </span></div><div class="line">** exception error: no match <span class="keyword">of</span> right hand side value <span class="number">2</span></div><div class="line"><span class="number">3</span>&gt; erlang:is_process_alive(v(<span class="number">1</span>)).<span class="comment">%% shell进程异常退出。另一个进程也退出了</span></div><div class="line"><span class="literal">false</span></div></pre></td></tr></table></figure>
<h5 id="验证P1退出，shell进程也退出"><a href="#验证P1退出，shell进程也退出" class="headerlink" title="验证P1退出，shell进程也退出"></a>验证P1退出，shell进程也退出</h5><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="number">4</span>&gt; a:start().</div><div class="line">&lt;<span class="number">0.133</span>.<span class="number">0</span>&gt;</div><div class="line"><span class="number">5</span>&gt; self().</div><div class="line">&lt;<span class="number">0.130</span>.<span class="number">0</span>&gt;</div><div class="line"><span class="number">6</span>&gt; erlang:exit(v(<span class="number">4</span>),shutdown).<span class="comment">%% 使另一个进程shutdown</span></div><div class="line">** exception exit: shutdown</div><div class="line"><span class="number">7</span>&gt; self().<span class="comment">%% 查看shell进程pid已经改变说明另一个进程shutdown后，shell进程也会退出</span></div><div class="line">&lt;<span class="number">0.113</span>.<span class="number">0</span>&gt;</div><div class="line"><span class="number">9</span>&gt; a:start().</div><div class="line">&lt;<span class="number">0.134</span>.<span class="number">0</span>&gt;</div><div class="line"><span class="number">10</span>&gt; erlang:exit(v(<span class="number">9</span>),normal).<span class="comment">%% 向P1发送exit(normal)消息</span></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">11</span>&gt; self().<span class="comment">%% shell进程还在,所以normal退出是不会影响监督进程的,原因请看下面的exit函数</span></div><div class="line">&lt;<span class="number">0.113</span>.<span class="number">0</span>&gt;</div></pre></td></tr></table></figure>
<h4 id="spawn-monitor一个新的进程"><a href="#spawn-monitor一个新的进程" class="headerlink" title="spawn_monitor一个新的进程"></a>spawn_monitor一个新的进程</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">-module</span><span class="params">(a)</span>.</div><div class="line"><span class="comment">%% API</span></div><div class="line"><span class="keyword">-export</span><span class="params">([start/<span class="number">0</span>])</span>.</div><div class="line"><span class="function"><span class="title">start</span><span class="params">()</span> -&gt;</span></div><div class="line">  P1 = proc_lib:spawn(<span class="keyword">fun</span>() -&gt; loop() <span class="keyword">end</span>),</div><div class="line">  erlang:monitor(process, P1),</div><div class="line">  P1.</div><div class="line"></div><div class="line"><span class="function"><span class="title">loop</span><span class="params">()</span> -&gt;</span></div><div class="line">  <span class="keyword">receive</span></div><div class="line">      Msg-&gt;</div><div class="line">       io:format(<span class="string">"receive =&gt; ~p ~n"</span>, [Msg]),</div><div class="line">        loop()</div><div class="line">  <span class="keyword">end</span>.</div></pre></td></tr></table></figure>
<h5 id="验证P1退出-shell进程也退出"><a href="#验证P1退出-shell进程也退出" class="headerlink" title="验证P1退出,shell进程也退出"></a>验证P1退出,shell进程也退出</h5><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>&gt; a:start().</div><div class="line">&lt;<span class="number">0.129</span>.<span class="number">0</span>&gt;</div><div class="line"><span class="number">2</span>&gt; self().</div><div class="line">&lt;<span class="number">0.113</span>.<span class="number">0</span>&gt;</div><div class="line"><span class="number">3</span>&gt; erlang:exit(v(<span class="number">1</span>),kill).<span class="comment">%%P1退出了</span></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">4</span>&gt; self().<span class="comment">%% shell的pid没有改变,这里跟link是有区别的</span></div><div class="line">&lt;<span class="number">0.113</span>.<span class="number">0</span>&gt;</div></pre></td></tr></table></figure>
<h5 id="改一下代码把进程收到的消息都打印一下"><a href="#改一下代码把进程收到的消息都打印一下" class="headerlink" title="改一下代码把进程收到的消息都打印一下"></a>改一下代码把进程收到的消息都打印一下</h5><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">-module</span><span class="params">(a)</span>.</div><div class="line"><span class="comment">%% API</span></div><div class="line"><span class="keyword">-export</span><span class="params">([start/<span class="number">0</span>])</span>.</div><div class="line"></div><div class="line"><span class="function"><span class="title">start</span><span class="params">()</span> -&gt;</span></div><div class="line">  P1 = proc_lib:spawn(<span class="keyword">fun</span>() -&gt; loop() <span class="keyword">end</span>),</div><div class="line">  P2 = proc_lib:spawn(<span class="keyword">fun</span>() -&gt; loop() <span class="keyword">end</span>),</div><div class="line">  P1 ! &#123;monitor,P2&#125;,</div><div class="line">  &#123;P1,P2&#125;.</div><div class="line"></div><div class="line"><span class="function"><span class="title">loop</span><span class="params">()</span> -&gt;</span></div><div class="line">  <span class="keyword">receive</span></div><div class="line">    &#123;monitor, P&#125; -&gt;</div><div class="line">     erlang:monitor(process, P),</div><div class="line">    loop();</div><div class="line">      Msg-&gt;</div><div class="line">       io:format(<span class="string">"self: ~p,receive =&gt; ~p ~n"</span>, [self() , Msg]),</div><div class="line">        loop()</div><div class="line">  <span class="keyword">end</span>.</div></pre></td></tr></table></figure>
<h5 id="再次验证monitor"><a href="#再次验证monitor" class="headerlink" title="再次验证monitor"></a>再次验证monitor</h5><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="number">4</span>&gt; &#123;P1,P2&#125;=a:start().       </div><div class="line">&#123;&lt;<span class="number">0.133</span>.<span class="number">0</span>&gt;,&lt;<span class="number">0.134</span>.<span class="number">0</span>&gt;&#125;</div><div class="line"><span class="number">5</span>&gt; erlang:exit(P2,kill). <span class="comment">%% P2异常退出</span></div><div class="line">self: &lt;<span class="number">0.133</span>.<span class="number">0</span>&gt;,<span class="keyword">receive</span> =&gt; &#123;'DOWN',#Ref&lt;<span class="number">0.563318561</span>.<span class="number">878182401.144252</span>&gt;,process,</div><div class="line">                                   &lt;<span class="number">0.134</span>.<span class="number">0</span>&gt;,killed&#125; <span class="comment">%% P1收到消息</span></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">6</span>&gt; f().                 </div><div class="line">ok</div><div class="line"><span class="number">7</span>&gt; &#123;P1,P2&#125;=a:start().   </div><div class="line">&#123;&lt;<span class="number">0.138</span>.<span class="number">0</span>&gt;,&lt;<span class="number">0.139</span>.<span class="number">0</span>&gt;&#125;</div><div class="line"><span class="number">8</span>&gt; erlang:exit(P1,shutdown).<span class="comment">%% P1异常退出</span></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">9</span>&gt; erlang:is_process_alive(P2).<span class="comment">%% P2不受影响</span></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">10</span>&gt; f().</div><div class="line"><span class="number">11</span>&gt; &#123;P1,P2&#125;=a:start().</div><div class="line">&#123;&lt;<span class="number">0.129</span>.<span class="number">0</span>&gt;,&lt;<span class="number">0.130</span>.<span class="number">0</span>&gt;&#125;</div><div class="line"><span class="number">12</span>&gt; erlang:exit(P2,normal).<span class="comment">%% P2正常退出</span></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">13</span>&gt; erlang:is_process_alive(P1).<span class="comment">%% P1不受影响</span></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">14</span>&gt; erlang:is_process_alive(P2).<span class="comment">%% P2没有退出具体原因请看exit函数</span></div></pre></td></tr></table></figure>
<h5 id="monitor的结果分析"><a href="#monitor的结果分析" class="headerlink" title="monitor的结果分析"></a>monitor的结果分析</h5><p>monitor方式监控进程不会跟随被监控进程退出，不过会收到被监控进程退出的消息</p>
<h3 id="加trap-exit为true的简单测试"><a href="#加trap-exit为true的简单测试" class="headerlink" title="加trap_exit为true的简单测试"></a>加trap_exit为true的简单测试</h3><p>erlang程序坚持的真理就是let it crash。根据前面的测试。如果两个进程是link方式的话<br>一个进程crash另一个进程也会crash，但是有时候业务层面需要被监督进程crash后监督进程还<br>可以进行工作，erlang提供了一个process_flag(trap_exit,true)来处理这个情况。<br><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">-module</span><span class="params">(a)</span>.</div><div class="line"><span class="comment">%% API</span></div><div class="line"><span class="keyword">-export</span><span class="params">([start/<span class="number">0</span>])</span>.</div><div class="line"><span class="function"><span class="title">start</span><span class="params">()</span> -&gt;</span></div><div class="line">  P1 = proc_lib:spawn_link(<span class="keyword">fun</span>() -&gt; erlang:process_flag(trap_exit,true), loop() <span class="keyword">end</span>),</div><div class="line">  P1.</div><div class="line"></div><div class="line"><span class="function"><span class="title">loop</span><span class="params">()</span> -&gt;</span></div><div class="line">  <span class="keyword">receive</span></div><div class="line">    Msg-&gt;</div><div class="line">      io:format(<span class="string">"receive =&gt; ~p ~n"</span>, [Msg]),</div><div class="line">      loop()</div><div class="line">  <span class="keyword">end</span>.</div></pre></td></tr></table></figure></p>
<h4 id="加了trap-exit的link方式"><a href="#加了trap-exit的link方式" class="headerlink" title="加了trap_exit的link方式"></a>加了trap_exit的link方式</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">&gt; a:start().</div><div class="line">&lt;<span class="number">0.128</span>.<span class="number">0</span>&gt;</div><div class="line"><span class="number">2</span>&gt; <span class="number">1</span>=<span class="number">2</span>.         </div><div class="line"><span class="keyword">receive</span> =&gt; &#123;'EXIT',&lt;<span class="number">0.112</span>.<span class="number">0</span>&gt;,&#123;&#123;badmatch,<span class="number">2</span>&#125;,[&#123;erl_eval,expr,<span class="number">3</span>,[]&#125;]&#125;&#125; <span class="comment">%% shell异常消息</span></div><div class="line"><span class="keyword">receive</span> =&gt; &#123;'EXIT',&lt;<span class="number">0.112</span>.<span class="number">0</span>&gt;,normal&#125; <span class="comment">%% shell退出消息</span></div><div class="line">** exception error: no match <span class="keyword">of</span> right hand side value <span class="number">2</span></div><div class="line"><span class="number">3</span>&gt; a:start().</div><div class="line">&lt;<span class="number">0.132</span>.<span class="number">0</span>&gt;</div><div class="line"><span class="number">4</span>&gt; erlang:exit(self(),normal).</div><div class="line"><span class="keyword">receive</span> =&gt; &#123;'EXIT',&lt;<span class="number">0.130</span>.<span class="number">0</span>&gt;,normal&#125; <span class="comment">%% exit(normal)消息</span></div><div class="line">** exception exit: normal</div><div class="line"><span class="number">5</span>&gt; a:start().</div><div class="line">&lt;<span class="number">0.136</span>.<span class="number">0</span>&gt;</div><div class="line"><span class="number">6</span>&gt; erlang:exit(self(),kill).</div><div class="line"><span class="keyword">receive</span> =&gt; &#123;'EXIT',&lt;<span class="number">0.134</span>.<span class="number">0</span>&gt;,killed&#125; <span class="comment">%% kill消息</span></div><div class="line">** exception exit: killed</div><div class="line"><span class="number">7</span>&gt; a:start().</div><div class="line">&lt;<span class="number">0.140</span>.<span class="number">0</span>&gt;</div><div class="line"><span class="number">8</span>&gt; erlang:exit(self(),shudown).<span class="comment">%%  shutdown消息</span></div><div class="line"><span class="keyword">receive</span> =&gt; &#123;'EXIT',&lt;<span class="number">0.138</span>.<span class="number">0</span>&gt;,shudown&#125; </div><div class="line">** exception exit: shudown</div><div class="line"><span class="number">9</span>&gt; a:start().</div><div class="line">&lt;<span class="number">0.144</span>.<span class="number">0</span>&gt;</div><div class="line"><span class="number">10</span>&gt; erlang:exit(self(),other).</div><div class="line"><span class="keyword">receive</span> =&gt; &#123;'EXIT',&lt;<span class="number">0.142</span>.<span class="number">0</span>&gt;,other&#125; <span class="comment">%% 别的任何消息</span></div><div class="line">** exception exit: other</div></pre></td></tr></table></figure>
<h4 id="加了trap-exit的monitor方式"><a href="#加了trap-exit的monitor方式" class="headerlink" title="加了trap_exit的monitor方式"></a>加了trap_exit的monitor方式</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">-module</span><span class="params">(a)</span>.</div><div class="line"><span class="comment">%% API</span></div><div class="line"><span class="keyword">-export</span><span class="params">([start/<span class="number">0</span>])</span>.</div><div class="line"></div><div class="line"><span class="function"><span class="title">start</span><span class="params">()</span> -&gt;</span></div><div class="line">  P1 = proc_lib:spawn(<span class="keyword">fun</span>() -&gt; erlang:process_flag(trap_exit, true),loop() <span class="keyword">end</span>),</div><div class="line">  P2 = proc_lib:spawn(<span class="keyword">fun</span>() -&gt; loop() <span class="keyword">end</span>),</div><div class="line">  P1 ! &#123;monitor,P2&#125;,</div><div class="line">  &#123;P1,P2&#125;.</div><div class="line"></div><div class="line"><span class="function"><span class="title">loop</span><span class="params">()</span> -&gt;</span></div><div class="line">  <span class="keyword">receive</span></div><div class="line">    &#123;monitor, P&#125; -&gt;</div><div class="line">     erlang:monitor(process, P),</div><div class="line">    loop();</div><div class="line">      Msg-&gt;</div><div class="line">       io:format(<span class="string">"self: ~p,receive =&gt; ~p ~n"</span>, [self() , Msg]),</div><div class="line">        loop()</div><div class="line">  <span class="keyword">end</span>.</div></pre></td></tr></table></figure>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="number">4</span>&gt; &#123;P1,P2&#125; = a:start().   </div><div class="line">&#123;&lt;<span class="number">0.134</span>.<span class="number">0</span>&gt;,&lt;<span class="number">0.135</span>.<span class="number">0</span>&gt;&#125;</div><div class="line"><span class="number">5</span>&gt; erlang:exit(P2,kill).</div><div class="line">self: &lt;<span class="number">0.134</span>.<span class="number">0</span>&gt;,<span class="keyword">receive</span> =&gt; &#123;'DOWN',#Ref&lt;<span class="number">0.465546185</span>.<span class="number">889454593.155663</span>&gt;,process,</div><div class="line">                                   &lt;<span class="number">0.135</span>.<span class="number">0</span>&gt;,killed&#125; <span class="comment">%% 设置了trap_exit,P2退出P1会打印信息</span></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">6</span>&gt; </div><div class="line"><span class="number">6</span>&gt; f().</div><div class="line">ok</div><div class="line"><span class="number">7</span>&gt; &#123;P1,P2&#125; = a:start(). </div><div class="line">&#123;&lt;<span class="number">0.139</span>.<span class="number">0</span>&gt;,&lt;<span class="number">0.140</span>.<span class="number">0</span>&gt;&#125;</div><div class="line"><span class="number">8</span>&gt; erlang:exit(P2,shutdown).</div><div class="line">self: &lt;<span class="number">0.139</span>.<span class="number">0</span>&gt;,<span class="keyword">receive</span> =&gt; &#123;'DOWN',#Ref&lt;<span class="number">0.465546185</span>.<span class="number">889454593.155680</span>&gt;,process,</div><div class="line">                                   &lt;<span class="number">0.140</span>.<span class="number">0</span>&gt;,shutdown&#125; </div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">9</span>&gt; f().</div><div class="line">ok</div><div class="line"><span class="number">10</span>&gt; &#123;P1,P2&#125; = a:start().     </div><div class="line">&#123;&lt;<span class="number">0.144</span>.<span class="number">0</span>&gt;,&lt;<span class="number">0.145</span>.<span class="number">0</span>&gt;&#125;</div><div class="line"><span class="number">11</span>&gt; erlang:exit(P2,other).   </div><div class="line">self: &lt;<span class="number">0.144</span>.<span class="number">0</span>&gt;,<span class="keyword">receive</span> =&gt; &#123;'DOWN',#Ref&lt;<span class="number">0.465546185</span>.<span class="number">889454593.155694</span>&gt;,process,</div><div class="line">                                   &lt;<span class="number">0.145</span>.<span class="number">0</span>&gt;,other&#125; </div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">12</span>&gt; f().</div><div class="line">ok</div><div class="line"><span class="number">13</span>&gt; &#123;P1,P2&#125; = a:start().  </div><div class="line">&#123;&lt;<span class="number">0.149</span>.<span class="number">0</span>&gt;,&lt;<span class="number">0.150</span>.<span class="number">0</span>&gt;&#125;</div><div class="line"><span class="number">20</span>&gt; erlang:exit(P1,normal).</div><div class="line">self: &lt;<span class="number">0.149</span>.<span class="number">0</span>&gt;,<span class="keyword">receive</span> =&gt; &#123;'EXIT',&lt;<span class="number">0.156</span>.<span class="number">0</span>&gt;,normal&#125; <span class="comment">%% 发送normal消息,设置了trap_exit,会打印消息。进程不会退出 </span></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">21</span>&gt; erlang:is_process_alive(P1).</div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">22</span>&gt; erlang:exit(P2,normal).</div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">23</span>&gt;erlang:is_process_alive(P2).<span class="comment">%% 发送normal消息不会退出,没有设置trap_exit也不会打印消息</span></div><div class="line"><span class="literal">true</span> </div><div class="line"><span class="number">24</span>&gt; erlang:exit(P1,normal).     </div><div class="line">self: &lt;<span class="number">0.149</span>.<span class="number">0</span>&gt;,<span class="keyword">receive</span> =&gt; &#123;'EXIT',&lt;<span class="number">0.156</span>.<span class="number">0</span>&gt;,normal&#125; </div><div class="line"><span class="literal">true</span></div></pre></td></tr></table></figure>
<h3 id="exit函数官方说明"><a href="#exit函数官方说明" class="headerlink" title="exit函数官方说明"></a>exit函数官方说明</h3><pre><code>Sends an exit signal with exit reason Reason to the process or port identified by Pid.

The following behavior applies if Reason is any term, except normal or kill:

  * If Pid is not trapping exits, Pid itself exits with exit reason Reason.

  * If Pid is trapping exits, the exit signal is transformed into a message {&apos;EXIT&apos;, From, Reason} and delivered to the message queue of Pid.

  * From is the process identifier of the process that sent the exit signal. See also process_flag/2.

If Reason is the atom normal, Pid does not exit. If it is trapping exits, the exit signal is transformed into a message {&apos;EXIT&apos;, From, normal} and delivered to
its message queue.

If Reason is the atom kill, that is, if exit(Pid, kill) is called, an untrappable exit signal is sent to Pid, which  unconditionally  exits  with  exit  reason
killed.
</code></pre><h3 id="Thanks"><a href="#Thanks" class="headerlink" title="Thanks"></a>Thanks</h3><p><a href="http://blog.differentpla.net/blog/2014/11/13/erlang-terminate" target="_blank" rel="external">erlang-terminate</a>.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/15/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Cameron">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Amazing Erlang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/15/hello-world/" itemprop="url">Hello World</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-15T14:58:31+08:00">
                2017-10-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/test/" itemprop="url" rel="index">
                    <span itemprop="name">test</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo new <span class="string">"My New Post"</span></div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo server</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo generate</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>
<h3 id="erlang"><a href="#erlang" class="headerlink" title="erlang"></a>erlang</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">get</span><span class="params">()</span> -&gt;</span></div><div class="line">lists:seq(<span class="number">1</span>,<span class="number">10</span>),</div><div class="line">ok.</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="Cameron" />
            
              <p class="site-author-name" itemprop="name">Cameron</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Cameron</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  
  

  

  

  

</body>
</html>
