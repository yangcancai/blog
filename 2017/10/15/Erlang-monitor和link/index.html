<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Erlang," />










<meta name="description" content="概述学习Erlang的童鞋都知道，erlang是一门高可靠的函数式编程语言。那么它是如何做到的呢？这篇文章就来探讨一下构成erlang高可靠系统的一个很小的部分，也是一个很重要的部分。erlang进程间的监督方式有link和monitor。link方式为两个进程之间相互监督，其中一个进程异常退出另一个进程也会受到影响。而monitor方式为单方面具有监督权，被监督进程异常退出监督进程会受到影响，反">
<meta name="keywords" content="Erlang">
<meta property="og:type" content="article">
<meta property="og:title" content="Erlang-monitor和link">
<meta property="og:url" content="http://yoursite.com/2017/10/15/Erlang-monitor和link/index.html">
<meta property="og:site_name" content="Amazing Erlang">
<meta property="og:description" content="概述学习Erlang的童鞋都知道，erlang是一门高可靠的函数式编程语言。那么它是如何做到的呢？这篇文章就来探讨一下构成erlang高可靠系统的一个很小的部分，也是一个很重要的部分。erlang进程间的监督方式有link和monitor。link方式为两个进程之间相互监督，其中一个进程异常退出另一个进程也会受到影响。而monitor方式为单方面具有监督权，被监督进程异常退出监督进程会受到影响，反">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2017-10-15T13:54:17.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Erlang-monitor和link">
<meta name="twitter:description" content="概述学习Erlang的童鞋都知道，erlang是一门高可靠的函数式编程语言。那么它是如何做到的呢？这篇文章就来探讨一下构成erlang高可靠系统的一个很小的部分，也是一个很重要的部分。erlang进程间的监督方式有link和monitor。link方式为两个进程之间相互监督，其中一个进程异常退出另一个进程也会受到影响。而monitor方式为单方面具有监督权，被监督进程异常退出监督进程会受到影响，反">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/10/15/Erlang-monitor和link/"/>





  <title>Erlang-monitor和link | Amazing Erlang</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Amazing Erlang</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/15/Erlang-monitor和link/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Cameron">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Amazing Erlang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Erlang-monitor和link</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-15T15:02:37+08:00">
                2017-10-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Erlang基础知识/" itemprop="url" rel="index">
                    <span itemprop="name">Erlang基础知识</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>学习Erlang的童鞋都知道，erlang是一门高可靠的函数式编程语言。那么它是如何做到的呢？<br>这篇文章就来探讨一下构成erlang高可靠系统的一个很小的部分，也是一个很重要的部分。<br>erlang进程间的监督方式有link和monitor。link方式为两个进程之间相互监督，<br>其中一个进程<font color="red">异常</font>退出另一个进程也会受到影响。而monitor方式为单方面具有监督权，<br>被监督进程<font color="red">异常</font>退出监督进程会受到影响，反之则不会受到影响。<br>大家注意到我这里为什么把<font color="red">异常</font>两个字加红色了吗？<br>因为如果我们向被监督进程发送exit(normal)消息的时候<br>监督进程是不会受到任何影响的。这也是需要注意的地方。</p>
<font color="red"> 这里的异常是指进程收到kill,shutdown,OtherReason但不包括normal。</font>

<h3 id="简单的测试"><a href="#简单的测试" class="headerlink" title="简单的测试"></a>简单的测试</h3><h4 id="spawn-link一个新的进程"><a href="#spawn-link一个新的进程" class="headerlink" title="spawn_link一个新的进程"></a>spawn_link一个新的进程</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">-module</span><span class="params">(a)</span>.</div><div class="line"><span class="comment">%% API</span></div><div class="line"><span class="keyword">-export</span><span class="params">([start/<span class="number">0</span>])</span>.</div><div class="line"><span class="function"><span class="title">start</span><span class="params">()</span> -&gt;</span></div><div class="line">  P1 = proc_lib:spawn_link(<span class="keyword">fun</span>() -&gt; loop() <span class="keyword">end</span>),</div><div class="line">  P1.</div><div class="line"></div><div class="line"><span class="function"><span class="title">loop</span><span class="params">()</span> -&gt;</span></div><div class="line">  <span class="keyword">receive</span></div><div class="line">      Msg-&gt;</div><div class="line">       io:format(<span class="string">"receive =&gt; ~p ~n"</span>, [Msg]),</div><div class="line">        loop()</div><div class="line">  <span class="keyword">end</span>.</div></pre></td></tr></table></figure>
<h5 id="验证shell异常退出，P1进程也退出"><a href="#验证shell异常退出，P1进程也退出" class="headerlink" title="验证shell异常退出，P1进程也退出"></a>验证shell异常退出，P1进程也退出</h5><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>&gt; a:start().<span class="comment">%% 启动一个进程根shell进程link在一起</span></div><div class="line">&lt;<span class="number">0.128</span>.<span class="number">0</span>&gt;</div><div class="line"><span class="number">2</span>&gt; <span class="number">1</span>=<span class="number">2</span>.  <span class="comment">%% 使shell进程异常退出 </span></div><div class="line">** exception error: no match <span class="keyword">of</span> right hand side value <span class="number">2</span></div><div class="line"><span class="number">3</span>&gt; erlang:is_process_alive(v(<span class="number">1</span>)).<span class="comment">%% shell进程异常退出。另一个进程也退出了</span></div><div class="line"><span class="literal">false</span></div></pre></td></tr></table></figure>
<h5 id="验证P1退出，shell进程也退出"><a href="#验证P1退出，shell进程也退出" class="headerlink" title="验证P1退出，shell进程也退出"></a>验证P1退出，shell进程也退出</h5><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="number">4</span>&gt; a:start().</div><div class="line">&lt;<span class="number">0.133</span>.<span class="number">0</span>&gt;</div><div class="line"><span class="number">5</span>&gt; self().</div><div class="line">&lt;<span class="number">0.130</span>.<span class="number">0</span>&gt;</div><div class="line"><span class="number">6</span>&gt; erlang:exit(v(<span class="number">4</span>),shutdown).<span class="comment">%% 使另一个进程shutdown</span></div><div class="line">** exception exit: shutdown</div><div class="line"><span class="number">7</span>&gt; self().<span class="comment">%% 查看shell进程pid已经改变说明另一个进程shutdown后，shell进程也会退出</span></div><div class="line">&lt;<span class="number">0.113</span>.<span class="number">0</span>&gt;</div><div class="line"><span class="number">9</span>&gt; a:start().</div><div class="line">&lt;<span class="number">0.134</span>.<span class="number">0</span>&gt;</div><div class="line"><span class="number">10</span>&gt; erlang:exit(v(<span class="number">9</span>),normal).<span class="comment">%% 向P1发送exit(normal)消息</span></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">11</span>&gt; self().<span class="comment">%% shell进程还在,所以normal退出是不会影响监督进程的</span></div><div class="line">&lt;<span class="number">0.113</span>.<span class="number">0</span>&gt;</div></pre></td></tr></table></figure>
<h4 id="spawn-monitor一个新的进程"><a href="#spawn-monitor一个新的进程" class="headerlink" title="spawn_monitor一个新的进程"></a>spawn_monitor一个新的进程</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">-module</span><span class="params">(a)</span>.</div><div class="line"><span class="comment">%% API</span></div><div class="line"><span class="keyword">-export</span><span class="params">([start/<span class="number">0</span>])</span>.</div><div class="line"><span class="function"><span class="title">start</span><span class="params">()</span> -&gt;</span></div><div class="line">  P1 = proc_lib:spawn(<span class="keyword">fun</span>() -&gt; loop() <span class="keyword">end</span>),</div><div class="line">  erlang:monitor(process, P1),</div><div class="line">  P1.</div><div class="line"></div><div class="line"><span class="function"><span class="title">loop</span><span class="params">()</span> -&gt;</span></div><div class="line">  <span class="keyword">receive</span></div><div class="line">      Msg-&gt;</div><div class="line">       io:format(<span class="string">"receive =&gt; ~p ~n"</span>, [Msg]),</div><div class="line">        loop()</div><div class="line">  <span class="keyword">end</span>.</div></pre></td></tr></table></figure>
<h5 id="验证P1退出-shell进程也退出"><a href="#验证P1退出-shell进程也退出" class="headerlink" title="验证P1退出,shell进程也退出"></a>验证P1退出,shell进程也退出</h5><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>&gt; a:start().</div><div class="line">&lt;<span class="number">0.129</span>.<span class="number">0</span>&gt;</div><div class="line"><span class="number">2</span>&gt; self().</div><div class="line">&lt;<span class="number">0.113</span>.<span class="number">0</span>&gt;</div><div class="line"><span class="number">3</span>&gt; erlang:exit(v(<span class="number">1</span>),kill).<span class="comment">%%P1退出了</span></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">4</span>&gt; self().<span class="comment">%% shell的pid没有改变</span></div><div class="line">&lt;<span class="number">0.113</span>.<span class="number">0</span>&gt;</div><div class="line">概述说明的monitor描述好像不对</div></pre></td></tr></table></figure>
<h5 id="改一下代码把进程收到的消息都打印一下"><a href="#改一下代码把进程收到的消息都打印一下" class="headerlink" title="改一下代码把进程收到的消息都打印一下"></a>改一下代码把进程收到的消息都打印一下</h5><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">-module</span><span class="params">(a)</span>.</div><div class="line"><span class="comment">%% API</span></div><div class="line"><span class="keyword">-export</span><span class="params">([start/<span class="number">0</span>])</span>.</div><div class="line"></div><div class="line"><span class="function"><span class="title">start</span><span class="params">()</span> -&gt;</span></div><div class="line">  P1 = proc_lib:spawn(<span class="keyword">fun</span>() -&gt; loop() <span class="keyword">end</span>),</div><div class="line">  P2 = proc_lib:spawn(<span class="keyword">fun</span>() -&gt; loop() <span class="keyword">end</span>),</div><div class="line">  P1 ! &#123;monitor,P2&#125;,</div><div class="line">  &#123;P1,P2&#125;.</div><div class="line"></div><div class="line"><span class="function"><span class="title">loop</span><span class="params">()</span> -&gt;</span></div><div class="line">  <span class="keyword">receive</span></div><div class="line">    &#123;monitor, P&#125; -&gt;</div><div class="line">     erlang:monitor(process, P),</div><div class="line">    loop();</div><div class="line">      Msg-&gt;</div><div class="line">       io:format(<span class="string">"self: ~p,receive =&gt; ~p ~n"</span>, [self() , Msg]),</div><div class="line">        loop()</div><div class="line">  <span class="keyword">end</span>.</div></pre></td></tr></table></figure>
<h5 id="再次验证monitor"><a href="#再次验证monitor" class="headerlink" title="再次验证monitor"></a>再次验证monitor</h5><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="number">4</span>&gt; &#123;P1,P2&#125;=a:start().       </div><div class="line">&#123;&lt;<span class="number">0.133</span>.<span class="number">0</span>&gt;,&lt;<span class="number">0.134</span>.<span class="number">0</span>&gt;&#125;</div><div class="line"><span class="number">5</span>&gt; erlang:exit(P2,kill). <span class="comment">%% P2异常退出</span></div><div class="line">self: &lt;<span class="number">0.133</span>.<span class="number">0</span>&gt;,<span class="keyword">receive</span> =&gt; &#123;'DOWN',#Ref&lt;<span class="number">0.563318561</span>.<span class="number">878182401.144252</span>&gt;,process,</div><div class="line">                                   &lt;<span class="number">0.134</span>.<span class="number">0</span>&gt;,killed&#125; <span class="comment">%% P1收到消息</span></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">6</span>&gt; f().                 </div><div class="line">ok</div><div class="line"><span class="number">7</span>&gt; &#123;P1,P2&#125;=a:start().   </div><div class="line">&#123;&lt;<span class="number">0.138</span>.<span class="number">0</span>&gt;,&lt;<span class="number">0.139</span>.<span class="number">0</span>&gt;&#125;</div><div class="line"><span class="number">8</span>&gt; erlang:exit(P1,shutdown).<span class="comment">%% P1异常退出</span></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">9</span>&gt; erlang:is_process_alive(P2).<span class="comment">%% P2不受影响</span></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">10</span>&gt; f().</div><div class="line"><span class="number">11</span>&gt; &#123;P1,P2&#125;=a:start().</div><div class="line">&#123;&lt;<span class="number">0.129</span>.<span class="number">0</span>&gt;,&lt;<span class="number">0.130</span>.<span class="number">0</span>&gt;&#125;</div><div class="line"><span class="number">12</span>&gt; erlang:exit(P2,normal).<span class="comment">%% P2正常退出</span></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">13</span>&gt; erlang:is_process_alive(P1).<span class="comment">%% P1不受影响</span></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">14</span>&gt; erlang:is_process_alive(P2).<span class="comment">%% P2没有退出具体原因请看exit函数</span></div></pre></td></tr></table></figure>
<h5 id="monitor的结果分析"><a href="#monitor的结果分析" class="headerlink" title="monitor的结果分析"></a>monitor的结果分析</h5><p>monitor方式监控进程不会跟随被监控进程退出，不过会收到被监控进程退出的消息</p>
<h3 id="加trap-exit为true的简单测试"><a href="#加trap-exit为true的简单测试" class="headerlink" title="加trap_exit为true的简单测试"></a>加trap_exit为true的简单测试</h3><p>erlang程序坚持的真理就是let it crash。根据前面的测试。如果两个进程是link方式的话<br>一个进程crash另一个进程也会crash，但是有时候业务层面需要被监督进程crash后监督进程还<br>可以进行工作，erlang提供了一个process_flag(trap_exit,true)来处理这个情况。<br><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">-module</span><span class="params">(a)</span>.</div><div class="line"><span class="comment">%% API</span></div><div class="line"><span class="keyword">-export</span><span class="params">([start/<span class="number">0</span>])</span>.</div><div class="line"><span class="function"><span class="title">start</span><span class="params">()</span> -&gt;</span></div><div class="line">  P1 = proc_lib:spawn_link(<span class="keyword">fun</span>() -&gt; erlang:process_flag(trap_exit,true), loop() <span class="keyword">end</span>),</div><div class="line">  P1.</div><div class="line"></div><div class="line"><span class="function"><span class="title">loop</span><span class="params">()</span> -&gt;</span></div><div class="line">  <span class="keyword">receive</span></div><div class="line">    Msg-&gt;</div><div class="line">      io:format(<span class="string">"receive =&gt; ~p ~n"</span>, [Msg]),</div><div class="line">      loop()</div><div class="line">  <span class="keyword">end</span>.</div></pre></td></tr></table></figure></p>
<h4 id="加了trap-exit的link方式"><a href="#加了trap-exit的link方式" class="headerlink" title="加了trap_exit的link方式"></a>加了trap_exit的link方式</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">&gt; a:start().</div><div class="line">&lt;<span class="number">0.128</span>.<span class="number">0</span>&gt;</div><div class="line"><span class="number">2</span>&gt; <span class="number">1</span>=<span class="number">2</span>.         </div><div class="line"><span class="keyword">receive</span> =&gt; &#123;'EXIT',&lt;<span class="number">0.112</span>.<span class="number">0</span>&gt;,&#123;&#123;badmatch,<span class="number">2</span>&#125;,[&#123;erl_eval,expr,<span class="number">3</span>,[]&#125;]&#125;&#125; <span class="comment">%% shell异常消息</span></div><div class="line"><span class="keyword">receive</span> =&gt; &#123;'EXIT',&lt;<span class="number">0.112</span>.<span class="number">0</span>&gt;,normal&#125; <span class="comment">%% shell退出消息</span></div><div class="line">** exception error: no match <span class="keyword">of</span> right hand side value <span class="number">2</span></div><div class="line"><span class="number">3</span>&gt; a:start().</div><div class="line">&lt;<span class="number">0.132</span>.<span class="number">0</span>&gt;</div><div class="line"><span class="number">4</span>&gt; erlang:exit(self(),normal).</div><div class="line"><span class="keyword">receive</span> =&gt; &#123;'EXIT',&lt;<span class="number">0.130</span>.<span class="number">0</span>&gt;,normal&#125; <span class="comment">%% exit(normal)消息</span></div><div class="line">** exception exit: normal</div><div class="line"><span class="number">5</span>&gt; a:start().</div><div class="line">&lt;<span class="number">0.136</span>.<span class="number">0</span>&gt;</div><div class="line"><span class="number">6</span>&gt; erlang:exit(self(),kill).</div><div class="line"><span class="keyword">receive</span> =&gt; &#123;'EXIT',&lt;<span class="number">0.134</span>.<span class="number">0</span>&gt;,killed&#125; <span class="comment">%% kill消息</span></div><div class="line">** exception exit: killed</div><div class="line"><span class="number">7</span>&gt; a:start().</div><div class="line">&lt;<span class="number">0.140</span>.<span class="number">0</span>&gt;</div><div class="line"><span class="number">8</span>&gt; erlang:exit(self(),shudown).<span class="comment">%%  shutdown消息</span></div><div class="line"><span class="keyword">receive</span> =&gt; &#123;'EXIT',&lt;<span class="number">0.138</span>.<span class="number">0</span>&gt;,shudown&#125; </div><div class="line">** exception exit: shudown</div><div class="line"><span class="number">9</span>&gt; a:start().</div><div class="line">&lt;<span class="number">0.144</span>.<span class="number">0</span>&gt;</div><div class="line"><span class="number">10</span>&gt; erlang:exit(self(),other).</div><div class="line"><span class="keyword">receive</span> =&gt; &#123;'EXIT',&lt;<span class="number">0.142</span>.<span class="number">0</span>&gt;,other&#125; <span class="comment">%% 别的任何消息</span></div><div class="line">** exception exit: other</div></pre></td></tr></table></figure>
<h4 id="加了trap-exit的monitor方式"><a href="#加了trap-exit的monitor方式" class="headerlink" title="加了trap_exit的monitor方式"></a>加了trap_exit的monitor方式</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">-module</span><span class="params">(a)</span>.</div><div class="line"><span class="comment">%% API</span></div><div class="line"><span class="keyword">-export</span><span class="params">([start/<span class="number">0</span>])</span>.</div><div class="line"></div><div class="line"><span class="function"><span class="title">start</span><span class="params">()</span> -&gt;</span></div><div class="line">  P1 = proc_lib:spawn(<span class="keyword">fun</span>() -&gt; erlang:process_flag(trap_exit, true),loop() <span class="keyword">end</span>),</div><div class="line">  P2 = proc_lib:spawn(<span class="keyword">fun</span>() -&gt; loop() <span class="keyword">end</span>),</div><div class="line">  P1 ! &#123;monitor,P2&#125;,</div><div class="line">  &#123;P1,P2&#125;.</div><div class="line"></div><div class="line"><span class="function"><span class="title">loop</span><span class="params">()</span> -&gt;</span></div><div class="line">  <span class="keyword">receive</span></div><div class="line">    &#123;monitor, P&#125; -&gt;</div><div class="line">     erlang:monitor(process, P),</div><div class="line">    loop();</div><div class="line">      Msg-&gt;</div><div class="line">       io:format(<span class="string">"self: ~p,receive =&gt; ~p ~n"</span>, [self() , Msg]),</div><div class="line">        loop()</div><div class="line">  <span class="keyword">end</span>.</div></pre></td></tr></table></figure>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="number">4</span>&gt; &#123;P1,P2&#125; = a:start().   </div><div class="line">&#123;&lt;<span class="number">0.134</span>.<span class="number">0</span>&gt;,&lt;<span class="number">0.135</span>.<span class="number">0</span>&gt;&#125;</div><div class="line"><span class="number">5</span>&gt; erlang:exit(P2,kill).</div><div class="line">self: &lt;<span class="number">0.134</span>.<span class="number">0</span>&gt;,<span class="keyword">receive</span> =&gt; &#123;'DOWN',#Ref&lt;<span class="number">0.465546185</span>.<span class="number">889454593.155663</span>&gt;,process,</div><div class="line">                                   &lt;<span class="number">0.135</span>.<span class="number">0</span>&gt;,killed&#125; <span class="comment">%% 设置了trap_exit,P2退出P1会打印信息</span></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">6</span>&gt; </div><div class="line"><span class="number">6</span>&gt; f().</div><div class="line">ok</div><div class="line"><span class="number">7</span>&gt; &#123;P1,P2&#125; = a:start(). </div><div class="line">&#123;&lt;<span class="number">0.139</span>.<span class="number">0</span>&gt;,&lt;<span class="number">0.140</span>.<span class="number">0</span>&gt;&#125;</div><div class="line"><span class="number">8</span>&gt; erlang:exit(P2,shutdown).</div><div class="line">self: &lt;<span class="number">0.139</span>.<span class="number">0</span>&gt;,<span class="keyword">receive</span> =&gt; &#123;'DOWN',#Ref&lt;<span class="number">0.465546185</span>.<span class="number">889454593.155680</span>&gt;,process,</div><div class="line">                                   &lt;<span class="number">0.140</span>.<span class="number">0</span>&gt;,shutdown&#125; </div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">9</span>&gt; f().</div><div class="line">ok</div><div class="line"><span class="number">10</span>&gt; &#123;P1,P2&#125; = a:start().     </div><div class="line">&#123;&lt;<span class="number">0.144</span>.<span class="number">0</span>&gt;,&lt;<span class="number">0.145</span>.<span class="number">0</span>&gt;&#125;</div><div class="line"><span class="number">11</span>&gt; erlang:exit(P2,other).   </div><div class="line">self: &lt;<span class="number">0.144</span>.<span class="number">0</span>&gt;,<span class="keyword">receive</span> =&gt; &#123;'DOWN',#Ref&lt;<span class="number">0.465546185</span>.<span class="number">889454593.155694</span>&gt;,process,</div><div class="line">                                   &lt;<span class="number">0.145</span>.<span class="number">0</span>&gt;,other&#125; </div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">12</span>&gt; f().</div><div class="line">ok</div><div class="line"><span class="number">13</span>&gt; &#123;P1,P2&#125; = a:start().  </div><div class="line">&#123;&lt;<span class="number">0.149</span>.<span class="number">0</span>&gt;,&lt;<span class="number">0.150</span>.<span class="number">0</span>&gt;&#125;</div><div class="line"><span class="number">20</span>&gt; erlang:exit(P1,normal).</div><div class="line">self: &lt;<span class="number">0.149</span>.<span class="number">0</span>&gt;,<span class="keyword">receive</span> =&gt; &#123;'EXIT',&lt;<span class="number">0.156</span>.<span class="number">0</span>&gt;,normal&#125; <span class="comment">%% 发送normal消息,设置了trap_exit,会打印消息。进程不会退出 </span></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">21</span>&gt; erlang:is_process_alive(P1).</div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">22</span>&gt; erlang:exit(P2,normal).</div><div class="line"><span class="literal">true</span></div><div class="line"><span class="number">23</span>&gt;erlang:is_process_alive(P2).<span class="comment">%% 发送normal消息不会退出,没有设置trap_exit也不会打印消息</span></div><div class="line"><span class="literal">true</span> </div><div class="line"><span class="number">24</span>&gt; erlang:exit(P1,normal).     </div><div class="line">self: &lt;<span class="number">0.149</span>.<span class="number">0</span>&gt;,<span class="keyword">receive</span> =&gt; &#123;'EXIT',&lt;<span class="number">0.156</span>.<span class="number">0</span>&gt;,normal&#125; </div><div class="line"><span class="literal">true</span></div></pre></td></tr></table></figure>
<h3 id="exit函数官方说明"><a href="#exit函数官方说明" class="headerlink" title="exit函数官方说明"></a>exit函数官方说明</h3><pre><code>Sends an exit signal with exit reason Reason to the process or port identified by Pid.

The following behavior applies if Reason is any term, except normal or kill:

  * If Pid is not trapping exits, Pid itself exits with exit reason Reason.

  * If Pid is trapping exits, the exit signal is transformed into a message {&apos;EXIT&apos;, From, Reason} and delivered to the message queue of Pid.

  * From is the process identifier of the process that sent the exit signal. See also process_flag/2.

If Reason is the atom normal, Pid does not exit. If it is trapping exits, the exit signal is transformed into a message {&apos;EXIT&apos;, From, normal} and delivered to
its message queue.

If Reason is the atom kill, that is, if exit(Pid, kill) is called, an untrappable exit signal is sent to Pid, which  unconditionally  exits  with  exit  reason
killed.
</code></pre>
      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div></div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.png" alt="Cameron 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.png" alt="Cameron 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Erlang/" rel="tag"># Erlang</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/10/15/hello-world/" rel="next" title="Hello World">
                <i class="fa fa-chevron-left"></i> Hello World
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="Cameron" />
            
              <p class="site-author-name" itemprop="name">Cameron</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#概述"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#简单的测试"><span class="nav-number">2.</span> <span class="nav-text">简单的测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#spawn-link一个新的进程"><span class="nav-number">2.1.</span> <span class="nav-text">spawn_link一个新的进程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#验证shell异常退出，P1进程也退出"><span class="nav-number">2.1.1.</span> <span class="nav-text">验证shell异常退出，P1进程也退出</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#验证P1退出，shell进程也退出"><span class="nav-number">2.1.2.</span> <span class="nav-text">验证P1退出，shell进程也退出</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#spawn-monitor一个新的进程"><span class="nav-number">2.2.</span> <span class="nav-text">spawn_monitor一个新的进程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#验证P1退出-shell进程也退出"><span class="nav-number">2.2.1.</span> <span class="nav-text">验证P1退出,shell进程也退出</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#改一下代码把进程收到的消息都打印一下"><span class="nav-number">2.2.2.</span> <span class="nav-text">改一下代码把进程收到的消息都打印一下</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#再次验证monitor"><span class="nav-number">2.2.3.</span> <span class="nav-text">再次验证monitor</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#monitor的结果分析"><span class="nav-number">2.2.4.</span> <span class="nav-text">monitor的结果分析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#加trap-exit为true的简单测试"><span class="nav-number">3.</span> <span class="nav-text">加trap_exit为true的简单测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#加了trap-exit的link方式"><span class="nav-number">3.1.</span> <span class="nav-text">加了trap_exit的link方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#加了trap-exit的monitor方式"><span class="nav-number">3.2.</span> <span class="nav-text">加了trap_exit的monitor方式</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exit函数官方说明"><span class="nav-number">4.</span> <span class="nav-text">exit函数官方说明</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Cameron</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  
  

  

  

  

</body>
</html>
